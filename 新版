import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  LayoutDashboard, Server, Users, Key, Activity, Settings, 
  LogOut, Plus, Trash2, RefreshCw, QrCode, Shield, 
  Smartphone, Globe, Zap, Search, Eye, EyeOff, ChevronRight,
  BookOpen, Sparkles, ScrollText, Calculator, Languages, Send, Bot, User, Menu, X, 
  GraduationCap, FileText, AlertTriangle, CheckCircle, Clock, Database, BarChart3, 
  XCircle, BrainCircuit, ShieldAlert, Lock, Wand2, Lightbulb, PenTool, 
  Bell, UploadCloud, FileType, Megaphone, Cpu, HardDrive, Save, Thermometer, UserCheck,
  HelpCircle, Calendar, MessageSquare, PlusCircle, MoreHorizontal, ChevronDown, Paperclip, Image as ImageIcon, File,
  Edit3, Share, ThumbsUp, ThumbsDown, Copy, Plane, Volume2, ImagePlus, Play, Square, Highlighter,
  Network, Scale, Gavel, AlertOctagon, Mic, Bookmark, Download, Star, Users2, ShieldCheck, Map as MapIcon,
  Target, Award, Timer, Hash, Layers, RotateCw, Check, Brain, FileSearch, Sliders, Fingerprint, MapPin, Laptop,
  Siren, Flame, Umbrella, LockKeyhole, Eye as EyeIcon, Radio, FileLock, KeyRound, Skull, Divide, FileJson,
  ZapOff, Gauge, Power, Hourglass, Loader2
} from 'lucide-react';

// --- ç³»ç»Ÿè¡¥ä¸ï¼šä¿®å¤æœªå®šä¹‰çš„å¼•ç”¨ ---
const XIcon = X; 
const apiKey = ""; // API Key å ä½ç¬¦ (ä»ç¯å¢ƒå˜é‡è¯»å–)
const BASE_URL = "https://generativelanguage.googleapis.com/v1beta"; 

// ==========================================
// ğŸ”Œ Backend Service (åç«¯è¿æ¥å±‚)
// ==========================================
/**
 * æ¨¡æ‹Ÿåç«¯æœåŠ¡å±‚
 * åœ¨çœŸå®é¡¹ç›®ä¸­ï¼Œå°† setTimeout æ›¿æ¢ä¸º fetch/axios è¯·æ±‚
 */
class BackendService {
  // æ¨¡æ‹Ÿåˆ é™¤ç”¨æˆ· API
  static async deleteUser(userId) {
    console.log(`[Backend] Requesting delete for user: ${userId}...`);
    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ 500ms
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // æ¨¡æ‹Ÿåç«¯é€»è¾‘ï¼šå¦‚æœIDå­˜åœ¨åˆ™è¿”å›æˆåŠŸ
    // const response = await fetch(`/api/v1/users/${userId}`, { method: 'DELETE' });
    
    console.log(`[Backend] User ${userId} deleted successfully.`);
    return { success: true, message: "User deleted" };
  }

  // æ¨¡æ‹Ÿè·å–ç”¨æˆ·åˆ—è¡¨ API
  static async fetchUsers() {
    await new Promise(resolve => setTimeout(resolve, 300));
    return [
      { id: 'STU_2024001', name: 'å¼ ä¸‰', class: 'é«˜ä¸‰(1)ç­', status: 'active', usage: '1.2M', tokenLimit: 'Dynamic', expiresAt: '2025-10-01' },
      { id: 'STU_2024002', name: 'æå››', class: 'é«˜ä¸‰(2)ç­', status: 'active', usage: '0.8M', tokenLimit: 'Dynamic', expiresAt: 'PERMANENT' },
      { id: 'STU_2024003', name: 'ç‹äº”', class: 'é«˜ä¸‰(5)ç­', status: 'banned', usage: '0.0M', tokenLimit: '0', expiresAt: '2024-12-31' }
    ];
  }
}

// ==========================================
// ğŸ” Security Core (çœŸå®å®‰å…¨å†…æ ¸)
// ==========================================

/**
 * æµè§ˆå™¨åŸç”Ÿ Web Crypto API å°è£…
 * å®ç° AES-256-GCM å¯¹ç§°åŠ å¯†
 */
class CryptoService {
  // ç”Ÿæˆ AES-GCM å¯†é’¥ (ç”¨äºä¼šè¯)
  static async generateKey() {
    return window.crypto.subtle.generateKey(
      { name: "AES-GCM", length: 256 },
      true,
      ["encrypt", "decrypt"]
    );
  }

  // åŠ å¯†æ•°æ®
  static async encrypt(text, key) {
    if (!key) throw new Error("å¯†é’¥æœªåˆå§‹åŒ–");
    const encoder = new TextEncoder();
    const data = encoder.encode(text);
    const iv = window.crypto.getRandomValues(new Uint8Array(12)); // 96-bit IV æ ‡å‡†æ¨è

    const ciphertext = await window.crypto.subtle.encrypt(
      { name: "AES-GCM", iv: iv },
      key,
      data
    );

    return {
      iv: Array.from(iv), // è½¬ä¸ºæ•°ç»„ä»¥ä¾¿å±•ç¤º
      ciphertext: Array.from(new Uint8Array(ciphertext))
    };
  }
}

/**
 * å®‰å…¨ç½‘å…³ï¼šè´Ÿè´£ WAF æ‹¦æˆªä¸éšç§æ¸…æ´—
 */
class SecurityGateway {
  static RULES = {
    phone: /(1[3-9]\d{9})/g,
    email: /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g,
    idCard: /(\d{15}|\d{18}|\d{17}(\d|X|x))/g,
    studentId: /(STU_\d+|20\d{6,})/g,
    // WAF ç‰¹å¾åº“ (Layer 7)
    sqli: /(\b(UNION|SELECT|INSERT|UPDATE|DELETE|DROP)\b)|(' OR '?'='?)/i,
    xss: /<script\b[^>]*>|javascript:|onerror=|onload=/i,
    modelLeak: /(openai|chatgpt|gemini|claude|llama|ä»€ä¹ˆå¤§æ¨¡å‹|ä½ æ˜¯å“ªå®¶|ä½ çš„åº•å±‚|ä»€ä¹ˆæ¨¡å‹|ä½ æ˜¯è°|ä½ çš„èº«ä»½|what model|who are you|åº•å±‚æŠ€æœ¯)/i
  };

  /**
   * å¤„ç†è¯·æ±‚ï¼šæ‰§è¡Œ WAF æ£€æŸ¥å’Œéšç§æ¸…æ´—
   * @throws Error å¦‚æœè§¦å‘ WAF è§„åˆ™
   */
  static processRequest(text, wafConfig, privacyRules, customKeywords = []) {
    // 1. WAF æ£€æŸ¥ (é˜²ç«å¢™)
    if (wafConfig.sql && this.RULES.sqli.test(text)) {
      throw new Error("WAF_BLOCK: æ£€æµ‹åˆ° SQL æ³¨å…¥æ”»å‡»ç‰¹å¾");
    }
    if (wafConfig.xss && this.RULES.xss.test(text)) {
      throw new Error("WAF_BLOCK: æ£€æµ‹åˆ°è·¨ç«™è„šæœ¬ (XSS) æ”»å‡»ç‰¹å¾");
    }

    // 2. éšç§æ¸…æ´— (DLP)
    let sanitizedText = text;
    let hasSensitiveData = false;
    const caughtItems = [];

    const replace = (regex, label) => {
      if (regex.test(sanitizedText)) {
        sanitizedText = sanitizedText.replace(regex, ` [ğŸ”’${label}] `);
        hasSensitiveData = true;
        if (!caughtItems.includes(label)) caughtItems.push(label);
      }
    };

    if (privacyRules.phone) replace(this.RULES.phone, 'éšç§_æ‰‹æœºå·');
    if (privacyRules.email) replace(this.RULES.email, 'éšç§_é‚®ç®±');
    if (privacyRules.idCard) replace(this.RULES.idCard, 'éšç§_èº«ä»½è¯');
    if (privacyRules.studentId) replace(this.RULES.studentId, 'éšç§_å­¦å·');
    if (privacyRules.modelLeak) replace(this.RULES.modelLeak, 'ç³»ç»Ÿä¿æŠ¤_æ¨¡å‹èº«ä»½');
    
    // è‡ªå®šä¹‰å…³é”®è¯
    customKeywords.forEach(keyword => {
      if (sanitizedText.includes(keyword)) {
        // ä½¿ç”¨ replaceAll ç¡®ä¿æ›¿æ¢æ‰€æœ‰å®ä¾‹
        const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        sanitizedText = sanitizedText.replace(new RegExp(escapedKeyword, 'g'), ' [ğŸš«æ•æ„Ÿè¯] ');
        hasSensitiveData = true;
        if (!caughtItems.includes('è‡ªå®šä¹‰æ•æ„Ÿè¯')) caughtItems.push('è‡ªå®šä¹‰æ•æ„Ÿè¯');
      }
    });

    return { sanitizedText, hasSensitiveData, caughtItems };
  }
}

// --- 1. å…¨å±€é…ç½® ---
const API_CONFIG = {
  COMPANY_NAME: 'é¾™åœºæ–‡åŒ–ç§‘æŠ€',
  ADMIN_APP_NAME: 'é¾™åœºäº‘ç«¯æ§åˆ¶å°',
  STUDENT_APP_NAME: 'Longchang Chat',
  TAGLINE: 'çŸ¥è¡Œåˆä¸€ Â· æ™ºæ…§ä¼´å­¦',
  DATA_RETENTION_DAYS: 60,
  DEFAULT_LLM_MODEL: 'OpenAI GPT-4-Turbo'
};

// --- å·¥å…·ç»„ä»¶ï¼šå€’è®¡æ—¶å™¨ ---
const CountdownTimer = ({ expiresAt, onExpire }) => {
  const [timeLeft, setTimeLeft] = useState('');
  useEffect(() => {
    if (expiresAt === 'PERMANENT') { setTimeLeft('â™¾ï¸ æ°¸ä¹…æœ‰æ•ˆ'); return; }
    const calculate = () => {
      const diff = new Date(expiresAt).getTime() - new Date().getTime();
      if (diff < 0) { setTimeLeft('âŒ å·²è¿‡æœŸ'); if(onExpire) onExpire(); return; }
      const d = Math.floor(diff / (1000 * 60 * 60 * 24));
      const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
      setTimeLeft(`${d}å¤© ${h}æ—¶`);
    };
    calculate();
    const t = setInterval(calculate, 60000);
    return () => clearInterval(t);
  }, [expiresAt]);
  return <span className="font-mono text-xs text-slate-600">{timeLeft}</span>;
};

const fileToBase64 = (file) => new Promise((resolve) => {
  const reader = new FileReader();
  reader.onload = () => resolve(reader.result.split(',')[1]);
  reader.readAsDataURL(file);
});

// --- Mock LLM ---
const callUnifiedLLM = async (messages, mode, taskType = 'chat', dataContext = null) => {
  await new Promise(r => setTimeout(r, 800));
  if (taskType === 'chat') return `[${API_CONFIG.DEFAULT_LLM_MODEL}]: è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„æ™ºèƒ½å›å¤ã€‚æ ¹æ® SecurityGateway è§„åˆ™ï¼Œæ‚¨çš„è¯·æ±‚å·²é€šè¿‡ WAF å’Œéšç§æ£€æŸ¥ã€‚`;
  if (taskType === 'analyze_logs') return "ã€AI å®‰å…¨å®¡è®¡ã€‘\nå‘ç° 3 ä¸ªå¼‚å¸¸ IP å°è¯•ç»•è¿‡ WAFï¼Œå·²è‡ªåŠ¨åŠ å…¥é»‘åå•ã€‚";
  if (taskType === 'draft_announcement') return "ã€ç³»ç»Ÿå…¬å‘Šã€‘\næœ¬å‘¨å…­å°†è¿›è¡Œå…¨ç«™å®‰å…¨å‡çº§ï¼Œå¼•å…¥åé‡å­å¯†ç å­¦åŠ å¯†å±‚ã€‚";
  if (taskType === 'polish_text') return `[å·²æ¶¦è‰²] ${dataContext || 'å†…å®¹'} (æ›´ä¼˜ç¾çš„è¡¨è¾¾...)`;
  return "AI æœåŠ¡å“åº”";
};

// è¯­éŸ³/å›¾åƒ API Mock
const callGeminiTTS = async () => null;

// --- æ•°æ® Mock ---
const LEARNING_MODES = [
  { id: 'general', name: 'å…¨èƒ½å¯¼å¸ˆ 4.0', short: 'å…¨èƒ½ 4.0', icon: Sparkles, desc: 'ç»¼åˆè¾…å¯¼' },
  { id: 'literature', name: 'å›½å­¦å¤§å¸ˆ Pro', short: 'å›½å­¦ Pro', icon: ScrollText, desc: 'å¤æ–‡å†™ä½œ' },
  { id: 'math', name: 'æ•°ç†é€»è¾‘ Max', short: 'æ•°ç† Max', icon: Calculator, desc: 'ç†ç§‘æ€ç»´' },
  { id: 'english', name: 'è‹±è¯­å¤–æ•™ Plus', short: 'è‹±è¯­ Plus', icon: Languages, desc: 'å£è¯­äº¤æµ' },
];

const SUGGESTIONS = [
  { icon: PenTool, text: "å¸®æˆ‘æ¶¦è‰²è¿™ç¯‡ä½œæ–‡", sub: "ä½¿å…¶æ›´å…·æ–‡é‡‡" },
  { icon: Calculator, text: "è§£é‡ŠäºŒæ¬¡å‡½æ•°", sub: "é€šä¿—æ˜“æ‡‚çš„æ–¹å¼" },
  { icon: Plane, text: "åˆ¶å®šå­¦ä¹ è®¡åˆ’", sub: "é’ˆå¯¹é«˜ä¸‰å¤ä¹ " }, 
  { icon: BrainCircuit, text: "èƒŒè¯µã€Šé•¿æ¨æ­Œã€‹", sub: "æä¾›è®°å¿†æŠ€å·§" },
];

const MOCK_EXAM_QUESTIONS = [
  { id: 1, type: 'single', question: 'ã€Šè®ºè¯­ã€‹ä¸­â€œå­¦è€Œæ—¶ä¹ ä¹‹â€çš„ä¸‹ä¸€å¥æ˜¯ï¼Ÿ', options: ['A. ä¸äº¦è¯´ä¹', 'B. ä¸äº¦ä¹ä¹', 'C. äººä¸çŸ¥è€Œä¸æ„ ', 'D. æ¸©æ•…è€ŒçŸ¥æ–°'], answer: 'A' },
  { id: 2, type: 'single', question: 'å·²çŸ¥å‡½æ•° f(x) = xÂ², åˆ™ f\'(2) ç­‰äºï¼Ÿ', options: ['A. 2', 'B. 4', 'C. 1', 'D. 0'], answer: 'B' },
];

const INITIAL_FLASHCARDS = [
  { id: 1, front: 'Subconscious', back: 'æ½œæ„è¯† (n.)', mastery: 'new' },
  { id: 2, front: 'Photosynthesis', back: 'å…‰åˆä½œç”¨ (n.)', mastery: 'new' },
];

const KNOWLEDGE_NODES = [
  { id: 'root', x: 400, y: 300, r: 40, label: 'é«˜ä¸­æ ¸å¿ƒ', color: '#4f46e5' },
  { id: 'math', x: 250, y: 150, r: 35, label: 'æ•°å­¦', color: '#0ea5e9' },
  { id: 'chinese', x: 550, y: 150, r: 35, label: 'è¯­æ–‡', color: '#ec4899' },
  { id: 'english', x: 250, y: 450, r: 35, label: 'è‹±è¯­', color: '#f59e0b' },
];
const KNOWLEDGE_LINKS = [{ from: 'root', to: 'math' }, { from: 'root', to: 'chinese' }, { from: 'root', to: 'english' }];

// --- Student App ---
const StudentApp = ({ onExitPreview, privacyRules, wafRules, onPrivacyTrigger, announcements, knowledgeFiles, customKeywords }) => {
  const [sessions, setSessions] = useState([{ id: 1, title: 'åˆæ¬¡è§é¢', messages: [], date: 'ä»Šå¤©' }]);
  const [currentSessionId, setCurrentSessionId] = useState(1);
  const [input, setInput] = useState('');
  const [mode, setMode] = useState(LEARNING_MODES[0]);
  const [isLoading, setIsLoading] = useState(false);
  const [showTools, setShowTools] = useState(false); 
  const [attachment, setAttachment] = useState(null); 
  const [viewMode, setViewMode] = useState('chat');
  const [isRecording, setIsRecording] = useState(false);
  
  // Exam & Flashcard State
  const [examState, setExamState] = useState({ currentQ: 0, answers: {}, finished: false, score: 0 });
  const [flashcards, setFlashcards] = useState(INITIAL_FLASHCARDS);
  const [currentCardIndex, setCurrentCardIndex] = useState(0);
  const [isCardFlipped, setIsCardFlipped] = useState(false);

  // Settings Modal
  const [showSettings, setShowSettings] = useState(false);

  const messagesEndRef = useRef(null);
  const fileInputRef = useRef(null);
  
  const currentSession = sessions.find(s => s.id === currentSessionId) || sessions[0];
  const messages = currentSession.messages || [];

  useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isLoading]);

  const updateCurrentSessionMessages = (newMessages) => {
    setSessions(prev => prev.map(s => s.id === currentSessionId ? { ...s, messages: newMessages } : s));
  };

  const createNewSession = () => {
    const newId = Date.now();
    setSessions([{ id: newId, title: 'æ–°å¯¹è¯', messages: [], date: 'ä»Šå¤©' }, ...sessions]);
    setCurrentSessionId(newId);
    setViewMode('chat');
  };

  const handleFileSelect = async (e) => {
    const file = e.target.files[0];
    if (file) {
      const base64 = await fileToBase64(file);
      setAttachment({ name: file.name, type: file.type, url: URL.createObjectURL(file), base64 });
    }
    e.target.value = null;
  };

  const sendMsg = async (overrideText = null) => {
    const textToSend = overrideText || input;
    if(!textToSend.trim() && !attachment) return;
    
    setInput(''); setAttachment(null); setShowTools(false);

    try {
      // ğŸ›¡ï¸ Security Gateway æ ¸å¿ƒè°ƒç”¨
      const { sanitizedText, hasSensitiveData, caughtItems } = SecurityGateway.processRequest(
        textToSend,
        wafRules,
        privacyRules,
        customKeywords
      );

      const userDisplayMsg = { role: 'user', content: textToSend, privacyBlocked: hasSensitiveData, attachment };
      const newMsgs = [...messages, userDisplayMsg];
      updateCurrentSessionMessages(newMsgs);

      if (hasSensitiveData) onPrivacyTrigger(caughtItems);

      setIsLoading(true);
      const apiMessages = newMsgs.map(m => ({ role: m.role, content: m.role==='user' && m.privacyBlocked ? sanitizedText : m.content }));
      
      const res = await callUnifiedLLM(apiMessages.slice(-5), mode.id, 'chat');
      
      let finalMsgs = [...newMsgs, { role: 'ai', content: res }];
      if (currentSession.messages.length === 0) {
         const newTitle = textToSend.length > 8 ? textToSend.slice(0, 8) + '...' : (textToSend || 'æ–‡ä»¶ä¸Šä¼ ');
         setSessions(prev => prev.map(s => s.id === currentSessionId ? { ...s, title: newTitle, messages: finalMsgs } : s));
      } else {
         updateCurrentSessionMessages(finalMsgs);
      }
    } catch (error) {
      // WAF æ‹¦æˆªå¤„ç†
      const blockedMsg = { role: 'user', content: textToSend, isBlocked: true, blockReason: error.message };
      updateCurrentSessionMessages([...messages, blockedMsg]);
    } finally {
      setIsLoading(false);
    }
  };

  const StudentSettingsModal = () => (
    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 animate-in fade-in">
        <div className="bg-white rounded-xl w-96 p-6 shadow-2xl">
            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Settings size={20} className="text-slate-700"/> è´¦æˆ·ä¸éšç§è®¾ç½®</h3>
            <div className="space-y-4">
                <div className="p-3 bg-slate-50 rounded-lg border border-slate-100">
                    <div className="text-xs text-slate-500 uppercase font-bold mb-1">æ•°æ®ä¿ç•™ç­–ç•¥</div>
                    <div className="text-sm text-slate-800">åŸå§‹å¯¹è¯ä¿ç•™ <span className="font-bold text-indigo-600">{API_CONFIG.DATA_RETENTION_DAYS} å¤©</span></div>
                </div>
                <button onClick={()=>alert("ç”³è¯·å·²æäº¤åå°åˆè§„ä¸­å¿ƒ")} className="w-full py-2 bg-red-50 text-red-600 border border-red-100 rounded-lg text-sm font-bold flex items-center justify-center gap-2"><Trash2 size={16}/> ç”³è¯·å½»åº•åˆ é™¤æ•°æ®</button>
            </div>
            <button onClick={() => setShowSettings(false)} className="mt-6 w-full py-2 bg-slate-800 text-white rounded-lg text-sm font-bold hover:bg-slate-700">å…³é—­</button>
        </div>
    </div>
  );

  return (
    <div className="flex h-screen bg-white font-sans text-gray-800 overflow-hidden relative">
      {showSettings && <StudentSettingsModal />}
      <aside className={`w-[260px] bg-[#000000] text-gray-100 flex flex-col md:relative fixed inset-y-0 left-0 z-50`}>
        <div className="p-3 flex items-center justify-between">
          <button onClick={createNewSession} className="flex-1 flex items-center gap-2 px-3 py-2.5 rounded-lg hover:bg-[#212121] transition-colors text-sm text-white border border-transparent hover:border-white/10">
            <div className="bg-white text-black rounded-full p-0.5"><Plus size={14}/></div><span className="font-medium">æ–°å¯¹è¯</span>
          </button>
          <button onClick={onExitPreview} className="text-xs bg-indigo-600 px-2 py-1 rounded ml-2">é€€å‡º</button>
        </div>
        
        <div className="px-3 py-2 space-y-1 border-b border-white/10 mb-2">
           <button onClick={() => setViewMode('graph')} className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm ${viewMode === 'graph' ? 'bg-indigo-600 text-white' : 'text-gray-400 hover:text-white hover:bg-[#212121]'}`}><Network size={16}/> çŸ¥è¯†å›¾è°±</button>
           <button onClick={() => setViewMode('exam')} className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm ${viewMode === 'exam' ? 'bg-indigo-600 text-white' : 'text-gray-400 hover:text-white hover:bg-[#212121]'}`}><Target size={16}/> æ¨¡æ‹Ÿè€ƒè¯•</button>
           <button onClick={() => setViewMode('flashcards')} className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm ${viewMode === 'flashcards' ? 'bg-indigo-600 text-white' : 'text-gray-400 hover:text-white hover:bg-[#212121]'}`}><Layers size={16}/> AI æ™ºèƒ½é—ªå¡</button>
        </div>

        <div className="flex-1 overflow-y-auto px-2 py-2 space-y-4 custom-scrollbar">
           {sessions.map(s => (<div key={s.id} onClick={() => { setCurrentSessionId(s.id); setViewMode('chat'); }} className={`group flex items-center gap-2 px-3 py-2.5 rounded-lg text-sm cursor-pointer relative overflow-hidden ${currentSessionId === s.id && viewMode === 'chat' ? 'bg-[#212121]' : 'hover:bg-[#212121]'}`}><MessageSquare size={16} className="text-gray-400 flex-shrink-0"/><span className="truncate flex-1 pr-6">{s.title}</span></div>))}
        </div>
        <div className="p-3 border-t border-white/10">
            <button onClick={() => setShowSettings(true)} className="flex items-center gap-3 w-full px-3 py-3 hover:bg-[#212121] rounded-lg transition-colors text-sm group">
                <div className="w-8 h-8 rounded bg-green-600 flex items-center justify-center text-white font-bold">S</div>
                <div className="flex flex-col items-start text-left"><span className="font-medium">Student</span><span className="text-xs text-gray-400">è®¾ç½®ä¸éšç§</span></div>
                <Settings size={14} className="ml-auto text-gray-500"/>
            </button>
        </div>
      </aside>

      <main className="flex-1 flex flex-col min-w-0 bg-slate-50">
        {viewMode === 'chat' ? (
          <>
            <div className="flex-1 overflow-y-auto relative custom-scrollbar bg-slate-50 p-4">
              {messages.map((m, i) => (
                <div key={i} className={`w-full py-2 px-4 md:px-0`}>
                  <div className={`flex gap-4 max-w-3xl mx-auto ${m.role === 'user' ? 'flex-row-reverse' : ''}`}>
                    <div className={`w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center ${m.role === 'user' ? 'bg-gray-200' : 'bg-green-500 text-white'}`}>{m.role === 'user' ? <User size={16} className="text-gray-600"/> : <Bot size={18}/>}</div>
                    <div className="relative flex-1 overflow-hidden">
                      <div className={`p-3 rounded-2xl text-sm ${m.role === 'user' ? (m.isBlocked ? 'bg-red-100 text-red-800 border border-red-200' : 'bg-white border border-gray-100') : 'bg-white border border-gray-100 shadow-sm'}`}>
                        {m.attachment && <div className="mb-2 p-2 bg-gray-50 rounded flex items-center gap-2"><FileText size={14}/> {m.attachment.name}</div>}
                        <div className="whitespace-pre-wrap">{m.content}</div>
                        {m.privacyBlocked && <div className="mt-2 inline-flex items-center gap-1.5 text-[10px] text-orange-600 bg-orange-50 px-2 py-1 rounded border border-orange-100"><ShieldAlert size={10} /> éšç§å·²è‡ªåŠ¨è„±æ•</div>}
                        {m.isBlocked && <div className="mt-2 inline-flex items-center gap-1.5 text-[10px] font-bold text-red-600"><AlertTriangle size={10}/> WAF æ‹¦æˆª: {m.blockReason}</div>}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
              {isLoading && <div className="flex justify-center p-4"><RefreshCw className="animate-spin text-gray-400"/></div>}
              <div ref={messagesEndRef} />
            </div>
            <div className="p-4 bg-white border-t">
              <div className="max-w-3xl mx-auto relative flex items-end border border-gray-300 rounded-2xl shadow-sm bg-white overflow-hidden focus-within:ring-2 ring-indigo-100">
                <button onClick={() => setShowTools(!showTools)} className="p-3 text-gray-400 hover:text-indigo-500"><Wand2 size={20} /></button>
                <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileSelect}/>
                <button onClick={() => fileInputRef.current?.click()} className="p-3 text-gray-400 hover:text-gray-600"><Paperclip size={20} /></button>
                <textarea value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); } }} rows={1} className="flex-1 py-3 px-0 bg-transparent border-none outline-none text-gray-800 resize-none max-h-32" placeholder="å‘é€æ¶ˆæ¯ (å·²å¯ç”¨ WAF é˜²æŠ¤)..."/>
                <button onClick={() => sendMsg()} disabled={isLoading || !input.trim()} className="p-2 m-2 bg-black text-white rounded-lg hover:bg-gray-800 disabled:opacity-50"><Send size={16} /></button>
              </div>
              {showTools && (<div className="absolute bottom-20 left-4 bg-white border rounded-xl shadow-xl p-2 z-10 w-48"><button onClick={() => {sendMsg("å¸®æˆ‘æ¶¦è‰²è¿™æ®µæ–‡å­—"); setShowTools(false);}} className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded text-sm flex gap-2"><PenTool size={14}/> æ¶¦è‰²</button></div>)}
            </div>
          </>
        ) : viewMode === 'graph' ? (
          <div className="flex-1 bg-slate-50 flex items-center justify-center relative">
             <div className="text-center text-slate-400"><Network size={64} className="mx-auto mb-4"/>çŸ¥è¯†å›¾è°±ç»„ä»¶ (ä¿ç•™åŸæ ·)</div>
          </div>
        ) : viewMode === 'exam' ? (
          <div className="flex-1 bg-slate-50 p-8 flex justify-center">
             <div className="w-full max-w-2xl bg-white p-6 rounded-2xl shadow-sm border">
                <h2 className="text-xl font-bold mb-4">æ¨¡æ‹Ÿè€ƒè¯•</h2>
                <div className="mb-4">{MOCK_EXAM_QUESTIONS[examState.currentQ].question}</div>
                {MOCK_EXAM_QUESTIONS[examState.currentQ].options.map(o=><div key={o} className="p-3 border rounded mb-2 hover:bg-gray-50 cursor-pointer">{o}</div>)}
                <div className="flex justify-between mt-6"><button className="text-gray-500">ä¸Šä¸€é¢˜</button><button className="bg-indigo-600 text-white px-4 py-2 rounded">ä¸‹ä¸€é¢˜</button></div>
             </div>
          </div>
        ) : (
          <div className="flex-1 bg-slate-50 flex items-center justify-center">
             <div className="w-80 h-96 bg-white rounded-2xl shadow-xl border flex items-center justify-center cursor-pointer" onClick={()=>setIsCardFlipped(!isCardFlipped)}>
                <h3 className="text-2xl font-bold">{isCardFlipped ? flashcards[currentCardIndex].back : flashcards[currentCardIndex].front}</h3>
             </div>
          </div>
        )}
      </main>
    </div>
  );
};

// ==========================================
// ğŸ›¡ï¸ Admin Dashboard (å…¨åŠŸèƒ½åå°)
// ==========================================
const INITIAL_NODES = [{ id: 1, name: 'é¦™æ¸¯ HK-01', type: 'Vmess', ip: '47.102.xx.xx', status: 'åœ¨çº¿', latency: '45ms' }, { id: 2, name: 'æ—¥æœ¬ JP-Osaka', type: 'Shadowsocks', ip: '103.20.xx.xx', status: 'åœ¨çº¿', latency: '89ms' }];
const INITIAL_API_KEYS = [{ id: 1, provider: 'OpenAI', model: 'GPT-4o', alias: 'Primary', keyMask: 'sk-***4f9a', balance: 'Active' }]; // å¯†é’¥å·²è„±æ•
const INITIAL_FILES = [{ id: 1, name: 'è®ºè¯­Â·å­¦è€Œç¯‡è§£æ.pdf', size: '2.4 MB', date: '2023-10-15' }, { id: 2, name: 'é«˜ä¸‰æ•°å­¦å‡½æ•°è€ƒç‚¹.docx', size: '1.1 MB', date: '2023-11-02' }];

export default function AdminDashboard() {
  const [currentView, setCurrentView] = useState('dashboard');
  const [nodes, setNodes] = useState(INITIAL_NODES);
  
  // ä½¿ç”¨çŠ¶æ€ç®¡ç†ç”¨æˆ·åˆ—è¡¨ï¼Œåˆå§‹æ•°æ®ä¸ºç©ºï¼Œå°†ä» BackendService è·å–
  const [users, setUsers] = useState([]);
  const [isLoadingUsers, setIsLoadingUsers] = useState(false);
  const [deletingUserId, setDeletingUserId] = useState(null); // è¿½è¸ªæ­£åœ¨åˆ é™¤çš„ç”¨æˆ·

  const [apiKeys, setApiKeys] = useState(INITIAL_API_KEYS);
  const [knowledgeFiles, setKnowledgeFiles] = useState(INITIAL_FILES);
  const [privacyRules, setPrivacyRules] = useState({ phone: true, email: true, idCard: true, studentId: true, modelLeak: true });
  const [wafRules, setWafRules] = useState({ sql: true, xss: true, ddos: true });
  const [customKeywords, setCustomKeywords] = useState(['å†…éƒ¨é¡¹ç›®', 'ProjectX']);
  const [showStudentPreview, setShowStudentPreview] = useState(false);
  const [privacyLogs, setPrivacyLogs] = useState([]);
  
  // Real Encryption State
  const [encryptInput, setEncryptInput] = useState('');
  const [encryptionResult, setEncryptionResult] = useState(null);
  const [sessionKey, setSessionKey] = useState(null);
  const [vaultStatus, setVaultStatus] = useState('locked');

  // Server Stats & Token Pool
  const [serverStats, setServerStats] = useState({ cpu: 0, ram: 0 });
  const [tokenPool, setTokenPool] = useState({ total: 100000000, used: 45000000, status: 'normal' });

  // Init Key
  useEffect(() => { CryptoService.generateKey().then(setSessionKey); }, []);

  // Simulator for Stats
  useEffect(() => {
    const timer = setInterval(() => {
      setServerStats({ cpu: Math.floor(Math.random()*30+10), ram: Math.floor(40+Math.random()*20) });
      setTokenPool(prev => {
        const fluctuation = Math.floor((Math.random() - 0.5) * 1000000);
        let newUsed = prev.used + fluctuation;
        let status = newUsed > prev.total * 0.8 ? 'peak' : newUsed < prev.total * 0.3 ? 'idle' : 'normal';
        return { ...prev, used: newUsed, status };
      });
    }, 2000);
    return () => clearInterval(timer);
  }, []);

  // Fetch Users on Load
  useEffect(() => {
    const loadUsers = async () => {
      setIsLoadingUsers(true);
      const data = await BackendService.fetchUsers();
      setUsers(data);
      setIsLoadingUsers(false);
    };
    loadUsers();
  }, []);

  const handleRunEncryption = async () => {
    if (!encryptInput || !sessionKey) return;
    try {
      const { iv, ciphertext } = await CryptoService.encrypt(encryptInput, sessionKey);
      setEncryptionResult({ iv: iv.join(','), ciphertext: ciphertext.join(','), algo: 'AES-256-GCM' });
    } catch (e) { alert("åŠ å¯†å¤±è´¥: " + e.message); }
  };

  // ğŸ—‘ï¸ åˆ é™¤ç”¨æˆ·å¤„ç†å‡½æ•°
  const handleDeleteUser = async (userId) => {
    if (!window.confirm(`ç¡®è®¤è¦åˆ é™¤ç”¨æˆ· ${userId} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) return;
    
    setDeletingUserId(userId);
    try {
      const res = await BackendService.deleteUser(userId);
      if (res.success) {
        // åç«¯æˆåŠŸåï¼Œæ›´æ–°æœ¬åœ°çŠ¶æ€
        setUsers(prev => prev.filter(u => u.id !== userId));
        addLog(`ç®¡ç†å‘˜åˆ é™¤äº†ç”¨æˆ·: ${userId}`, 'warning');
      }
    } catch (error) {
      alert("åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
    } finally {
      setDeletingUserId(null);
    }
  };

  const addLog = (msg, type='info') => setPrivacyLogs(prev => [{id: Date.now(), msg, type, time: new Date().toLocaleTimeString()}, ...prev].slice(0, 50));
  const handlePrivacyTrigger = (items) => addLog(`æ‹¦æˆªæ•æ„Ÿä¿¡æ¯: ${items.join(', ')}`, 'warning');

  // Render Helpers
  const SafeHTMLRender = ({ text }) => {
    const parts = text.split(/(\[ğŸ”’[^\]]+\]|\[ğŸš«[^\]]+\])/g);
    return <div className="font-mono text-sm bg-slate-900 text-slate-300 p-3 rounded-lg break-all whitespace-pre-wrap">{parts.map((p, i) => (p.startsWith('[ğŸ”’') || p.startsWith('[ğŸš«')) ? <span key={i} className="text-red-400 font-bold">{p}</span> : <span key={i}>{p}</span>)}</div>;
  };

  if (showStudentPreview) return <StudentApp onExitPreview={() => setShowStudentPreview(false)} privacyRules={privacyRules} wafRules={wafRules} customKeywords={customKeywords} onPrivacyTrigger={handlePrivacyTrigger} announcements={[]} knowledgeFiles={knowledgeFiles}/>;

  const renderContent = () => {
    switch (currentView) {
      case 'dashboard': return (
        <div className="space-y-6">
          <div className="grid grid-cols-4 gap-6">
             <div className="bg-white p-6 rounded-xl border shadow-sm"><div className="text-xs font-bold text-slate-500">SYSTEM CPU</div><div className="text-2xl font-bold text-indigo-600 mt-2">{serverStats.cpu}%</div><div className="w-full bg-slate-100 h-1 mt-2"><div style={{width: `${serverStats.cpu}%`}} className="bg-indigo-600 h-full"></div></div></div>
             <div className="bg-white p-6 rounded-xl border shadow-sm"><div className="text-xs font-bold text-slate-500">MEMORY</div><div className="text-2xl font-bold text-emerald-600 mt-2">{serverStats.ram}%</div><div className="w-full bg-slate-100 h-1 mt-2"><div style={{width: `${serverStats.ram}%`}} className="bg-emerald-600 h-full"></div></div></div>
             <div className="bg-white p-6 rounded-xl border shadow-sm"><div className="text-xs font-bold text-slate-500">TOKEN POOL</div><div className="text-2xl font-bold text-blue-600 mt-2">{(tokenPool.used/1000000).toFixed(1)}M</div><div className="text-xs text-slate-400">{tokenPool.status.toUpperCase()}</div></div>
             <div className="bg-white p-6 rounded-xl border shadow-sm"><div className="text-xs font-bold text-slate-500">WAF EVENTS</div><div className="text-2xl font-bold text-red-600 mt-2">{privacyLogs.length}</div></div>
          </div>
          <div className="bg-white p-6 rounded-xl border shadow-sm">
             <h3 className="font-bold mb-4 flex items-center gap-2"><Gauge size={18}/> Token åŠ¨æ€è°ƒåº¦æ±  (å…¨ç«™ç®—åŠ›)</h3>
             <div className="relative h-10 bg-slate-100 rounded-lg overflow-hidden"><div style={{width: `${(tokenPool.used/tokenPool.total)*100}%`}} className={`h-full flex items-center justify-end px-3 text-white text-xs font-bold transition-all duration-1000 ${tokenPool.status==='peak'?'bg-orange-500':tokenPool.status==='idle'?'bg-green-500':'bg-blue-600'}`}>{((tokenPool.used/tokenPool.total)*100).toFixed(1)}%</div></div>
          </div>
        </div>
      );
      case 'security': return (
        <div className="space-y-6">
           <div className="grid grid-cols-2 gap-6">
              <div className="bg-white p-6 rounded-xl border shadow-sm">
                 <h3 className="font-bold mb-4 flex items-center gap-2"><ShieldCheck className="text-emerald-500"/> WAF é˜²æŠ¤ç­–ç•¥</h3>
                 <div className="space-y-4">
                    {['sql', 'xss', 'ddos'].map(k => (
                       <div key={k} className="flex justify-between items-center p-3 bg-slate-50 rounded border"><span className="uppercase font-bold text-sm">{k} Protection</span><button onClick={()=>setWafRules({...wafRules, [k]:!wafRules[k]})} className={`w-10 h-5 rounded-full relative transition-colors ${wafRules[k]?'bg-emerald-500':'bg-slate-300'}`}><div className={`w-3 h-3 bg-white rounded-full absolute top-1 transition-all ${wafRules[k]?'left-6':'left-1'}`}></div></button></div>
                    ))}
                 </div>
              </div>
              <div className="bg-white p-6 rounded-xl border shadow-sm border-l-4 border-l-orange-500">
                 <h3 className="font-bold mb-4 flex items-center gap-2"><ZapOff className="text-orange-500"/> å¼‚å¸¸è¡Œä¸ºç†”æ–­å™¨</h3>
                 <div className="p-4 bg-orange-50 rounded border border-orange-100 mb-4"><div className="font-bold text-orange-800 text-sm">è‡ªåŠ¨ç†”æ–­ (Auto Fusion)</div><div className="text-xs text-orange-600">å½“ QPS &gt; 60 æ—¶è‡ªåŠ¨åˆ‡æ–­ç«¯å£å¹¶å†»ç»“è´¦æˆ· 10-60 åˆ†é’Ÿã€‚</div></div>
                 <button onClick={()=>alert("æ¨¡æ‹Ÿï¼šæ£€æµ‹åˆ°é«˜é¢‘æ”»å‡»ï¼Œç«¯å£å·²ç†”æ–­ï¼ŒIPå·²å°ç¦ã€‚")} className="w-full py-2 bg-slate-900 text-white rounded text-sm font-bold">æ¨¡æ‹Ÿæ”»å‡»è§¦å‘</button>
              </div>
           </div>
        </div>
      );
      case 'encryption': return (
        <div className="space-y-6">
           <div className="bg-white p-6 rounded-xl border shadow-sm">
              <div className="flex justify-between items-center mb-6">
                 <h3 className="font-bold flex items-center gap-2"><LockKeyhole className="text-indigo-600"/> æ•°æ®ä¿é™©åº“ (Web Crypto API)</h3>
                 <button onClick={()=>setVaultStatus(s=>s==='locked'?'unlocked':'locked')} className={`px-3 py-1 rounded text-xs font-bold ${vaultStatus==='locked'?'bg-red-100 text-red-600':'bg-green-100 text-green-600'}`}>{vaultStatus==='locked'?'VAULT LOCKED':'VAULT OPEN'}</button>
              </div>
              <div className="grid grid-cols-2 gap-6">
                 <div>
                    <textarea className="w-full h-32 p-3 border rounded text-sm font-mono focus:ring-2 focus:ring-indigo-500" placeholder="è¯·è¾“å…¥æ•æ„Ÿæ•°æ®..." value={encryptInput} onChange={e=>setEncryptInput(e.target.value)}/>
                    <button onClick={handleRunEncryption} className="mt-2 w-full bg-indigo-600 text-white py-2 rounded font-bold flex items-center justify-center gap-2"><RefreshCw size={14}/> æ‰§è¡Œ AES-256-GCM åŠ å¯†</button>
                 </div>
                 <div className="bg-slate-900 p-4 rounded text-green-400 text-xs font-mono break-all overflow-y-auto h-44 border border-slate-700">
                    {encryptionResult ? <><div className="mb-2 text-indigo-300">Algo: {encryptionResult.algo}</div><div className="mb-2 text-orange-300">IV: [{encryptionResult.iv}]</div><div>Cipher: [{encryptionResult.ciphertext}]</div></> : "// ç­‰å¾…åŠ å¯†..."}
                 </div>
              </div>
           </div>
        </div>
      );
      case 'privacy': return (
        <div className="space-y-6">
           <div className="bg-white p-6 rounded-xl border shadow-sm">
              <h3 className="font-bold mb-4 flex items-center gap-2"><EyeOff className="text-indigo-600"/> éšç§è§„åˆ™é…ç½®</h3>
              <div className="flex flex-wrap gap-2 mb-6">
                 {Object.keys(privacyRules).map(r=><button key={r} onClick={()=>setPrivacyRules({...privacyRules, [r]:!privacyRules[r]})} className={`px-3 py-1 rounded text-xs border ${privacyRules[r]?'bg-indigo-50 border-indigo-200 text-indigo-700':'bg-white text-slate-500'}`}>{r}</button>)}
              </div>
              <h4 className="font-bold text-sm mb-2">å®‰å…¨æ²™ç®±æµ‹è¯• (Safe Render)</h4>
              <div className="grid grid-cols-2 gap-4">
                 <textarea className="p-3 border rounded text-sm h-32" placeholder="è¾“å…¥: æˆ‘çš„æ‰‹æœºå·æ˜¯ 13800138000, å¹¶åœ¨ SQL ä¸­å°è¯• ' OR 1=1" onChange={(e)=>{ try { const res=SecurityGateway.processRequest(e.target.value, wafRules, privacyRules, customKeywords); setEncryptionResult(res); } catch(err){ setEncryptionResult({error: err.message}); } }}/>
                 <div className="bg-slate-900 rounded p-3 text-xs overflow-auto h-32">
                    {encryptionResult?.error ? <span className="text-red-500 font-bold">{encryptionResult.error}</span> : encryptionResult?.sanitizedText ? <SafeHTMLRender text={encryptionResult.sanitizedText}/> : <span className="text-slate-500">ç­‰å¾…è¾“å…¥...</span>}
                 </div>
              </div>
           </div>
        </div>
      );
      case 'users': return (
        <div className="bg-white p-6 rounded-xl border shadow-sm">
           <h3 className="font-bold mb-4 flex items-center justify-between">
             ç”¨æˆ·ç®¡ç†
             {isLoadingUsers && <div className="flex items-center gap-2 text-sm text-slate-400"><Loader2 className="animate-spin" size={14}/> æ­£åœ¨ä» Backend è·å–æ•°æ®...</div>}
           </h3>
           <table className="w-full text-sm text-left">
             <thead>
               <tr className="border-b text-slate-500">
                 <th className="pb-2">ID</th>
                 <th className="pb-2">å§“å</th>
                 <th className="pb-2">Token æ¨¡å¼</th>
                 <th className="pb-2">æœ‰æ•ˆæœŸ</th>
                 <th className="pb-2 text-right">æ“ä½œ</th>
               </tr>
             </thead>
             <tbody>
               {users.map(u=>(
                 <tr key={u.id} className="border-b last:border-0 hover:bg-slate-50 transition-colors">
                   <td className="py-2 font-mono">{u.id}</td>
                   <td className="py-2">{u.name}</td>
                   <td className="py-2"><span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">{u.tokenLimit}</span></td>
                   <td className="py-2"><CountdownTimer expiresAt={u.expiresAt}/></td>
                   <td className="py-2 text-right">
                     <button 
                       onClick={() => handleDeleteUser(u.id)} 
                       disabled={deletingUserId === u.id}
                       className="text-red-500 hover:bg-red-50 p-2 rounded transition-colors disabled:opacity-50"
                       title="åˆ é™¤ç”¨æˆ·"
                     >
                       {deletingUserId === u.id ? <Loader2 className="animate-spin" size={16}/> : <Trash2 size={16}/>}
                     </button>
                   </td>
                 </tr>
               ))}
             </tbody>
           </table>
        </div>
      );
      case 'nodes': return (
        <div className="bg-white p-6 rounded-xl border shadow-sm">
           <div className="flex justify-between mb-4"><h3 className="font-bold">èŠ‚ç‚¹ç®¡ç†</h3><button className="text-xs bg-black text-white px-2 py-1 rounded">æ·»åŠ èŠ‚ç‚¹</button></div>
           {nodes.map(n=>(<div key={n.id} className="flex justify-between p-3 border-b last:border-0"><span className="font-medium">{n.name}</span><span className="text-green-600 text-xs">{n.latency}</span></div>))}
        </div>
      );
      case 'knowledge': return (
        <div className="bg-white p-6 rounded-xl border shadow-sm">
           <div className="flex justify-between mb-4"><h3 className="font-bold">RAG çŸ¥è¯†åº“</h3><button className="text-xs bg-black text-white px-2 py-1 rounded">ä¸Šä¼ æ–‡æ¡£</button></div>
           {knowledgeFiles.map(f=>(<div key={f.id} className="flex items-center gap-3 p-3 border rounded mb-2"><FileText size={16}/><div className="flex-1 text-sm font-medium">{f.name}</div><div className="text-xs text-slate-400">{f.size}</div></div>))}
        </div>
      );
      case 'api': return (
        <div className="bg-white p-6 rounded-xl border shadow-sm">
           <h3 className="font-bold mb-4">API å¯†é’¥æ±  (è„±æ•)</h3>
           {apiKeys.map(k=>(<div key={k.id} className="flex justify-between p-3 border rounded mb-2"><div className="font-bold text-sm">{k.alias} <span className="font-normal text-xs bg-slate-100 px-1 rounded">{k.model}</span></div><div className="font-mono text-xs text-slate-400">{k.keyMask}</div></div>))}
        </div>
      );
      case 'logs': return (
        <div className="bg-white p-6 rounded-xl border shadow-sm">
           <h3 className="font-bold mb-4">ç³»ç»Ÿå®¡è®¡æ—¥å¿—</h3>
           <div className="h-64 overflow-y-auto">{privacyLogs.map(l=>(<div key={l.id} className="text-xs py-1 border-b"><span className="text-slate-400 mr-2">[{l.time}]</span>{l.msg}</div>))}</div>
        </div>
      );
      default: return null;
    }
  };

  return (
    <div className="flex h-screen bg-slate-50 font-sans text-slate-800 overflow-hidden">
      <aside className="w-64 bg-slate-900 text-white flex flex-col flex-shrink-0">
        <div className="p-6 flex items-center gap-3 border-b border-slate-800"><Shield className="text-indigo-500" /><div><div className="font-bold text-sm">é¾™åœºå®‰å…¨æ¶æ„</div><div className="text-[10px] text-slate-400">Security MVP v2.0</div></div></div>
        <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
          {[
            {id: 'dashboard', icon: LayoutDashboard, label: 'æ€åŠ¿æ„ŸçŸ¥'},
            {id: 'security', icon: ShieldCheck, label: 'å®‰å…¨é£æ§ WAF'},
            {id: 'encryption', icon: LockKeyhole, label: 'æ•°æ®ä¿é™©åº“'},
            {id: 'privacy', icon: EyeOff, label: 'éšç§æ¸…æ´—è§„åˆ™'},
            {id: 'users', icon: Users, label: 'ç”¨æˆ·ç®¡ç†'},
            {id: 'nodes', icon: Server, label: 'èŠ‚ç‚¹ç®¡ç†'},
            {id: 'knowledge', icon: BookOpen, label: 'çŸ¥è¯†åº“ RAG'},
            {id: 'api', icon: Zap, label: 'API å¯†é’¥æ± '},
            {id: 'server', icon: Cpu, label: 'æœåŠ¡å™¨ç›‘æ§'},
            {id: 'logs', icon: FileText, label: 'å®¡è®¡æ—¥å¿—'},
          ].map(item => (<button key={item.id} onClick={() => setCurrentView(item.id)} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg transition-colors ${currentView===item.id ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}><item.icon size={18}/> <span>{item.label}</span></button>))}
        </nav>
        <div className="p-4 border-t border-slate-800"><button onClick={() => setShowStudentPreview(true)} className="w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 p-2 rounded text-sm text-indigo-400 transition-colors"><Smartphone size={16}/> é¢„è§ˆå­¦ç”Ÿç«¯</button></div>
      </aside>
      <main className="flex-1 overflow-auto p-8">{renderContent()}</main>
    </div>
  );
}
