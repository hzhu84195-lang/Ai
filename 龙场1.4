import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  LayoutDashboard, Server, Users, Key, Activity, Settings, 
  LogOut, Plus, Trash2, RefreshCw, QrCode, Shield, 
  Smartphone, Globe, Zap, Search, Eye, EyeOff, ChevronRight,
  BookOpen, Sparkles, ScrollText, Calculator, Languages, Send, Bot, User, Menu, X, 
  GraduationCap, FileText, AlertTriangle, CheckCircle, Clock, Database, BarChart3, 
  XCircle, BrainCircuit, ShieldAlert, Lock, Wand2, Lightbulb, PenTool, 
  Bell, UploadCloud, FileType, Megaphone, Cpu, HardDrive, Save, Thermometer, UserCheck,
  HelpCircle, Calendar, MessageSquare, PlusCircle, MoreHorizontal, ChevronDown, Paperclip, Image as ImageIcon, File,
  Edit3, Share, ThumbsUp, ThumbsDown, Copy, Plane, Volume2, ImagePlus, Play, Square, Highlighter,
  Network, Scale, Gavel, AlertOctagon, Mic, Bookmark, Download, Star, Users2, ShieldCheck, Map as MapIcon,
  Target, Award, Timer, Hash, Layers, RotateCw, Check, Brain, FileSearch, Sliders, Fingerprint, MapPin, Laptop,
  Siren, Flame, Umbrella, LockKeyhole, Eye as EyeIcon, Radio, FileLock, KeyRound, Skull, Divide, FileJson,
  ZapOff, Gauge, Power, Hourglass
} from 'lucide-react';

// --- ç³»ç»Ÿè¡¥ä¸ï¼šä¿®å¤æœªå®šä¹‰çš„å¼•ç”¨ ---
const XIcon = X; 
const apiKey = ""; // API Key å ä½ç¬¦
const BASE_URL = "https://generativelanguage.googleapis.com/v1beta"; // Gemini API Base URL

// --- 1. å…¨å±€é…ç½® ---
const API_CONFIG = {
  COMPANY_NAME: 'é¾™åœºæ–‡åŒ–ç§‘æŠ€',
  ADMIN_APP_NAME: 'é¾™åœºäº‘ç«¯æ§åˆ¶å°',
  STUDENT_APP_NAME: 'Longchang Chat',
  TAGLINE: 'çŸ¥è¡Œåˆä¸€ Â· æ™ºæ…§ä¼´å­¦',
  DATA_RETENTION_DAYS: 60, // é»˜è®¤æ•°æ®ä¿ç•™å¤©æ•°
  DEFAULT_LLM_MODEL: 'OpenAI GPT-4-Turbo' // é»˜è®¤åå°é…ç½®çš„å¤§æ¨¡å‹
};

// --- 2. éšç§æ¸…æ´—å¼•æ“ (å‡çº§ç‰ˆï¼šæ”¯æŒåŠ¨æ€å…³é”®è¯) ---
const PRIVACY_REGEX = {
  phone: /(1[3-9]\d{9})/g,
  email: /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g,
  idCard: /(\d{15}|\d{18}|\d{17}(\d|X|x))/g,
  bankCard: /(\d{16}|\d{19})/g,
  studentId: /(STU_\d+|20\d{6,})/g,
  studentName: /(å¼ ä¸‰|æå››|ç‹äº”|èµµå…­|[\u4e00-\u9fa5]{2,4}(?=åŒå­¦|è€å¸ˆ|å®¶é•¿))/g,
  modelLeak: /(openai|chatgpt|gemini|claude|llama|ä»€ä¹ˆå¤§æ¨¡å‹|ä½ æ˜¯å“ªå®¶|ä½ çš„åº•å±‚|ä»€ä¹ˆæ¨¡å‹|ä½ æ˜¯è°|ä½ çš„èº«ä»½|what model|who are you|åº•å±‚æŠ€æœ¯)/i
};

const localPrivacyFilter = (text, rules, customKeywords = []) => {
  let sanitizedText = text;
  let hasSensitiveData = false;
  const caughtItems = [];

  // 1. æ­£åˆ™è§„åˆ™è¿‡æ»¤
  const checkAndReplace = (ruleKey, regex, label) => {
    if (rules[ruleKey] && regex.test(text)) {
      sanitizedText = sanitizedText.replace(regex, ` [ğŸ”’${label}] `);
      hasSensitiveData = true;
      if (!caughtItems.includes(label)) caughtItems.push(label);
    }
  };

  checkAndReplace('phone', PRIVACY_REGEX.phone, 'éšç§_æ‰‹æœºå·');
  checkAndReplace('email', PRIVACY_REGEX.email, 'éšç§_é‚®ç®±');
  checkAndReplace('idCard', PRIVACY_REGEX.idCard, 'éšç§_èº«ä»½è¯');
  checkAndReplace('studentId', PRIVACY_REGEX.studentId, 'éšç§_å­¦å·');
  checkAndReplace('studentName', PRIVACY_REGEX.studentName, 'éšç§_å§“å');
  
  if (rules.modelLeak && PRIVACY_REGEX.modelLeak.test(text)) {
    sanitizedText = sanitizedText.replace(PRIVACY_REGEX.modelLeak, ' [ğŸ›¡ï¸è‡ªä¸»ç ”å‘æ¶æ„] ');
    hasSensitiveData = true;
    if (!caughtItems.includes('æ¨¡å‹èº«ä»½')) caughtItems.push('æ¨¡å‹èº«ä»½');
  }

  // 2. è‡ªå®šä¹‰å…³é”®è¯è¿‡æ»¤ (æ–°å¢)
  customKeywords.forEach(keyword => {
    if (text.includes(keyword)) {
      const regex = new RegExp(keyword, 'g');
      sanitizedText = sanitizedText.replace(regex, ' [ğŸš«æ•æ„Ÿè¯] ');
      hasSensitiveData = true;
      if (!caughtItems.includes('è‡ªå®šä¹‰æ•æ„Ÿè¯')) caughtItems.push('è‡ªå®šä¹‰æ•æ„Ÿè¯');
    }
  });
  
  return { sanitizedText, hasSensitiveData, caughtItems };
};

// --- å·¥å…·ç»„ä»¶ï¼šå€’è®¡æ—¶å™¨ ---
const CountdownTimer = ({ expiresAt, onExpire }) => {
  const [timeLeft, setTimeLeft] = useState('');
  const [isExpired, setIsExpired] = useState(false);

  useEffect(() => {
    if (expiresAt === 'PERMANENT') {
      setTimeLeft('â™¾ï¸ æ°¸ä¹…æœ‰æ•ˆ');
      return;
    }

    const calculateTime = () => {
      const now = new Date().getTime();
      const distance = new Date(expiresAt).getTime() - now;

      if (distance < 0) {
        setTimeLeft('âŒ å·²è¿‡æœŸ');
        setIsExpired(true);
        if (onExpire) onExpire(); 
        return;
      }

      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);

      setTimeLeft(`${days}å¤© ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);
    };

    calculateTime();
    const timer = setInterval(calculateTime, 1000);
    return () => clearInterval(timer);
  }, [expiresAt]);

  return <span className={`font-mono text-xs ${isExpired ? 'text-red-500 font-bold' : 'text-slate-600'}`}>{timeLeft}</span>;
};

// --- å·¥å…·å‡½æ•° ---
const fileToBase64 = (file) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = error => reject(error);
  });
};

// --- 3. Unified LLM Gateway (æ¨¡æ‹Ÿåç«¯ç»Ÿä¸€æ¥å£) ---
const callUnifiedLLM = async (messages, mode, taskType = 'chat', dataContext = null) => {
  // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
  await new Promise(resolve => setTimeout(resolve, 800));

  if (taskType === 'chat') {
      return `[${API_CONFIG.DEFAULT_LLM_MODEL} å“åº”]: è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„æ™ºèƒ½å›å¤ã€‚æ ¹æ®åå°é…ç½®ï¼Œæˆ‘å½“å‰è¿è¡Œåœ¨ OpenAI æ¶æ„ä¸Šã€‚æ‚¨çš„éšç§æ•°æ®å·²è¿‡æ»¤ã€‚`;
  } 
  else if (taskType === 'analyze_logs') {
      return "ã€AI å®‰å…¨å®¡è®¡æŠ¥å‘Šã€‘\né£é™©ç­‰çº§ï¼šä½\n1. æ£€æµ‹åˆ° 3 æ¬¡å°è¯•æ€§çš„ SQL æ³¨å…¥æ¨¡å¼ï¼Œå·²è¢« WAF æ‹¦æˆªã€‚\n2. IP 192.168.x.x è®¿é—®é¢‘ç‡ç•¥é«˜ï¼Œå»ºè®®æŒç»­è§‚å¯Ÿã€‚\n3. ç³»ç»Ÿæ•´ä½“åŠ å¯†å±‚è¿è¡Œæ­£å¸¸ï¼Œæœªå‘ç°å¯†é’¥æ³„éœ²è¿¹è±¡ã€‚";
  }
  else if (taskType === 'draft_announcement') {
      return "ã€ç³»ç»Ÿå‡çº§å…¬å‘Šã€‘\nå„ä½åŒå­¦ã€è€å¸ˆå¥½ï¼š\nä¸ºäº†æä¾›æ›´ä¼˜è´¨çš„ AI è¾…å¯¼ä½“éªŒï¼Œé¾™åœºç§‘æŠ€å­¦ä¹ å¹³å°å°†äºæœ¬å‘¨äº”å‡Œæ™¨ 02:00 è¿›è¡Œåº•å±‚æ¨¡å‹å‡çº§ã€‚å‡çº§æœŸé—´æœåŠ¡å¯èƒ½ä¼šæœ‰çŸ­æš‚æ³¢åŠ¨ã€‚\n\næœ¬æ¬¡æ›´æ–°å°†æ¥å…¥æ›´å¼ºå¤§çš„æ¨ç†æ¨¡å‹ï¼Œå¹¶åŠ å¼ºæ•°æ®éšç§ä¿æŠ¤ã€‚æ„Ÿè°¢æ‚¨çš„ç†è§£ä¸æ”¯æŒï¼\n\né¾™åœºæŠ€æœ¯å›¢é˜Ÿ";
  }
  else if (taskType === 'polish_text') {
      return `[å·²æ¶¦è‰²] ${dataContext || 'å†…å®¹'} (æ›´ä¼˜ç¾çš„è¡¨è¾¾...)`;
  }
  
  return "AI æœåŠ¡æš‚ä¸å¯ç”¨ã€‚";
};

// è¯­éŸ³ç”Ÿæˆ API (TTS)
const callGeminiTTS = async (text) => {
  const url = `${BASE_URL}/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
  const payload = { contents: [{ parts: [{ text: text }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } } };
  try {
    return null;
  } catch (error) { return null; }
};

// --- 4. å­¦ç”Ÿç«¯ UI ç»„ä»¶ ---
const LEARNING_MODES = [
  { id: 'general', name: 'å…¨èƒ½å¯¼å¸ˆ 4.0', short: 'å…¨èƒ½ 4.0', icon: Sparkles, desc: 'ç»¼åˆè¾…å¯¼èƒ½åŠ›', gradient: 'from-blue-500 to-cyan-400', theme: 'blue' },
  { id: 'literature', name: 'å›½å­¦å¤§å¸ˆ Pro', short: 'å›½å­¦ Pro', icon: ScrollText, desc: 'å¤æ–‡ä¸å†™ä½œ', gradient: 'from-indigo-500 to-purple-500', theme: 'indigo' },
  { id: 'math', name: 'æ•°ç†é€»è¾‘ Max', short: 'æ•°ç† Max', icon: Calculator, desc: 'ç†ç§‘æ€ç»´', gradient: 'from-emerald-500 to-teal-400', theme: 'emerald' },
  { id: 'english', name: 'è‹±è¯­å¤–æ•™ Plus', short: 'è‹±è¯­ Plus', icon: Languages, desc: 'åœ°é“å£è¯­äº¤æµ', gradient: 'from-rose-500 to-pink-500', theme: 'rose' },
];

const SUGGESTIONS = [
  { icon: PenTool, text: "å¸®æˆ‘æ¶¦è‰²è¿™ç¯‡ä½œæ–‡", sub: "ä½¿å…¶æ›´å…·æ–‡é‡‡" },
  { icon: Calculator, text: "è§£é‡ŠäºŒæ¬¡å‡½æ•°", sub: "é€šä¿—æ˜“æ‡‚çš„æ–¹å¼" },
  { icon: Plane, text: "åˆ¶å®šå­¦ä¹ è®¡åˆ’", sub: "é’ˆå¯¹é«˜ä¸‰å¤ä¹ " }, 
  { icon: BrainCircuit, text: "èƒŒè¯µã€Šé•¿æ¨æ­Œã€‹", sub: "æä¾›è®°å¿†æŠ€å·§" },
];

const KNOWLEDGE_NODES = [
  { id: 'root', x: 400, y: 300, r: 40, label: 'é«˜ä¸­æ ¸å¿ƒ', color: '#4f46e5' },
  { id: 'math', x: 250, y: 150, r: 35, label: 'æ•°å­¦', color: '#0ea5e9' },
  { id: 'chinese', x: 550, y: 150, r: 35, label: 'è¯­æ–‡', color: '#ec4899' },
  { id: 'english', x: 250, y: 450, r: 35, label: 'è‹±è¯­', color: '#f59e0b' },
  { id: 'func', x: 150, y: 100, r: 25, label: 'å‡½æ•°', color: '#0ea5e9' },
  { id: 'geom', x: 150, y: 200, r: 25, label: 'å‡ ä½•', color: '#0ea5e9' },
  { id: 'poem', x: 650, y: 100, r: 25, label: 'å¤è¯—è¯', color: '#ec4899' },
  { id: 'comp', x: 650, y: 200, r: 25, label: 'ä½œæ–‡', color: '#ec4899' },
];

const KNOWLEDGE_LINKS = [
  { from: 'root', to: 'math' }, { from: 'root', to: 'chinese' }, { from: 'root', to: 'english' },
  { from: 'math', to: 'func' }, { from: 'math', to: 'geom' },
  { from: 'chinese', to: 'poem' }, { from: 'chinese', to: 'comp' },
];

// éšç§æ ‡ç­¾æ˜ å°„è¡¨
const PRIVACY_LABELS = {
  phone: 'æ‰‹æœºå·ç ',
  email: 'ç”µå­é‚®ç®±',
  idCard: 'èº«ä»½è¯å·',
  bankCard: 'é“¶è¡Œå¡å·',
  studentId: 'å­¦ç”Ÿå­¦å·',
  studentName: 'çœŸå®å§“å',
  modelLeak: 'æ¨¡å‹èº«ä»½ä¿æŠ¤'
};

const StudentApp = ({ onExitPreview, privacyRules, onPrivacyTrigger, announcements, knowledgeFiles, customKeywords }) => {
  const [sessions, setSessions] = useState([{ id: 1, title: 'åˆæ¬¡è§é¢', messages: [], date: 'ä»Šå¤©' }]);
  const [bookmarks, setBookmarks] = useState([]); 
  const [currentSessionId, setCurrentSessionId] = useState(1);
  const [input, setInput] = useState('');
  const [mode, setMode] = useState(LEARNING_MODES[0]);
  const [isLoading, setIsLoading] = useState(false);
  const [showModelMenu, setShowModelMenu] = useState(false);
  const [showHistory, setShowHistory] = useState(true);
  const [showTools, setShowTools] = useState(false); 
  const [showNotices, setShowNotices] = useState(false);
  const [attachment, setAttachment] = useState(null); 
  const [audioPlaying, setAudioPlaying] = useState(null);
  const [viewMode, setViewMode] = useState('chat');
  const [isRecording, setIsRecording] = useState(false); 
  
  // New: Student Settings Modal State
  const [showSettings, setShowSettings] = useState(false);

  const fileInputRef = useRef(null);
  const messagesEndRef = useRef(null);
  const textareaRef = useRef(null);
  const audioRef = useRef(null); 

  const currentSession = sessions.find(s => s.id === currentSessionId) || sessions[0] || { id: 0, title: 'New', messages: [], date: '' };
  const messages = currentSession.messages || [];

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto';
      textareaRef.current.style.height = Math.min(textareaRef.current.scrollHeight, 200) + 'px';
    }
  }, [messages, isLoading, attachment, input, viewMode]);

  const updateCurrentSessionMessages = (newMessages) => {
    setSessions(prev => prev.map(s => s.id === currentSessionId ? { ...s, messages: newMessages } : s));
  };

  const createNewSession = () => {
    const newId = Date.now();
    const newSession = { id: newId, title: 'æ–°å¯¹è¯', messages: [], date: 'ä»Šå¤©' };
    setSessions([newSession, ...sessions]);
    setCurrentSessionId(newId);
    setViewMode('chat');
    if (window.innerWidth < 768) setShowHistory(false);
  };

  const handleExportChat = () => {
    const textContent = messages.map(m => `[${m.role === 'user' ? 'å­¦ç”Ÿ' : 'AI'}] ${m.content}`).join('\n\n');
    const blob = new Blob([textContent], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `é¾™åœºå­¦ä¹ è®°å½•_${new Date().toISOString().slice(0,10)}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };

  const handleQuickPrompt = (prompt) => { 
    setInput(prompt); 
    if (textareaRef.current) textareaRef.current.focus(); 
  };

  const handleVoiceInput = () => {
    if (!('webkitSpeechRecognition' in window)) {
      alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Edgeã€‚");
      return;
    }
    if (isRecording) {
        setIsRecording(false);
        return;
    }
    setIsRecording(true);
    setTimeout(() => {
        setInput(prev => prev + " (è¯­éŸ³è¾“å…¥å†…å®¹...)");
        setIsRecording(false);
    }, 2000);
  };

  const handleFileSelect = async (e) => {
    const file = e.target.files[0];
    if (file) {
      const base64 = await fileToBase64(file);
      setAttachment({ name: file.name, type: file.type, url: URL.createObjectURL(file), fileObj: file, base64: base64 });
    }
    e.target.value = null;
  };

  const handlePlayAudio = async (text, index) => {
    if (!audioRef.current) audioRef.current = new Audio();
    if (audioPlaying === index) { audioRef.current.pause(); setAudioPlaying(null); return; }
    audioRef.current.pause(); setAudioPlaying(index); 
    const audioUrl = await callGeminiTTS(text);
    if (audioUrl) { audioRef.current.src = audioUrl; audioRef.current.play(); audioRef.current.onended = () => setAudioPlaying(null); } 
    else { setAudioPlaying(null); alert("è¯­éŸ³ç”ŸæˆåŠŸèƒ½éœ€é…ç½® API Key"); }
  };

  const sendMsg = async (overrideText = null) => {
    const textToSend = overrideText || input;
    if(!textToSend.trim() && !attachment) return;
    
    setInput(''); setAttachment(null); setShowTools(false);
    
    const { sanitizedText, hasSensitiveData, caughtItems } = localPrivacyFilter(textToSend, privacyRules, customKeywords);
    const userDisplayMsg = { role: 'user', content: textToSend, privacyBlocked: hasSensitiveData, attachment };
    const newMsgs = [...messages, userDisplayMsg];
    updateCurrentSessionMessages(newMsgs);
    
    if (caughtItems.includes('æ¨¡å‹èº«ä»½') || caughtItems.includes('è‡ªå®šä¹‰æ•æ„Ÿè¯')) { 
       onPrivacyTrigger(caughtItems); 
       setIsLoading(true); 
       setTimeout(() => { 
         updateCurrentSessionMessages([...newMsgs, { role: 'ai', content: `[ç³»ç»Ÿå®‰å…¨æ‹¦æˆª] æ£€æµ‹åˆ°æ•æ„Ÿå†…å®¹æˆ–è¿è§„æŸ¥è¯¢ã€‚` }]); 
         setIsLoading(false); 
       }, 600); 
       return; 
    }

    setIsLoading(true); if (hasSensitiveData) onPrivacyTrigger(caughtItems);
    const apiMessages = newMsgs.map(m => ({ role: m.role, content: m.role === 'user' && m.privacyBlocked ? sanitizedText : m.content, attachment: m.attachment }));
    const context = knowledgeFiles.map(f => `[æ–‡æ¡£: ${f.name}]`);
    
    const res = await callUnifiedLLM(apiMessages.slice(-10), mode.id, 'chat', context);
    
    if (currentSession.messages.length <= 0) { 
        const newTitle = textToSend.length > 8 ? textToSend.slice(0, 8) + '...' : (textToSend || 'æ–‡ä»¶ä¸Šä¼ '); 
        setSessions(prev => prev.map(s => s.id === currentSessionId ? { ...s, title: newTitle, messages: [...newMsgs, { role: 'ai', content: res }] } : s)); 
    } else { 
        updateCurrentSessionMessages([...newMsgs, { role: 'ai', content: res }]); 
    }
    setIsLoading(false);
  };

  const handleAiTool = async (type) => {
    setShowTools(false); setIsLoading(true); let res = "";
    if (type === 'suggest') res = await callUnifiedLLM([], mode.id, 'suggest_topic');
    else if (type === 'image') { updateCurrentSessionMessages([...messages, { role: 'ai', content: `[åå°é…ç½®] å›¾åƒç”ŸæˆæœåŠ¡éœ€è¿æ¥åç«¯ã€‚`, image: null }]); setIsLoading(false); return; } // Placeholder
    else if (type === 'mindmap') { res = await callUnifiedLLM([], mode.id, 'generate_mindmap', input || "è¯·æŒ‡å®šä¸»é¢˜"); }
    else if (type === 'logic') { res = await callUnifiedLLM([], mode.id, 'check_logic', input || "è¯·è¾“å…¥è®ºç‚¹"); }
    else if (type === 'debate') { res = await callUnifiedLLM([], mode.id, 'debate', input || "è¯·æŒ‡å®šè¾©é¢˜"); }
    else if (type === 'socratic') { res = await callUnifiedLLM([], mode.id, 'socratic', input || "è¯·æå‡ºä½ çš„é—®é¢˜"); }
    else if (type === 'polish') { const polished = await callUnifiedLLM([], mode.id, 'polish_text', input); setInput(polished.trim()); setIsLoading(false); return; }
    
    updateCurrentSessionMessages([...messages, { role: 'ai', content: res }]); setIsLoading(false);
  };

  const handleDataDeletionRequest = () => {
    if (window.confirm("ã€âš ï¸ ä¸¥é‡è­¦å‘Šã€‘\n\næ‚¨æ­£åœ¨ç”³è¯·â€œå½»åº•åˆ é™¤æ•°æ®â€ã€‚\n\n- æ‚¨çš„æ‰€æœ‰åŸå§‹å¯¹è¯è®°å½•å°†åœ¨ç³»ç»Ÿä¸­è¢«ç‰©ç†æ“¦é™¤ã€‚\n- æ‚¨çš„å­¦ä¹ ç”»åƒå’Œè¡Œä¸ºç»Ÿè®¡å°†è¢«ä¿ç•™ï¼ˆå»æ ‡è¯†åŒ–ï¼‰ã€‚\n- æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚\n\næ˜¯å¦ç¡®è®¤æäº¤ç”³è¯·ï¼Ÿ")) {
        alert("ç”³è¯·å·²æäº¤è‡³åå°åˆè§„ä¸­å¿ƒã€‚\nç³»ç»Ÿå°†åœ¨ 24 å°æ—¶å†…å¤„ç†æ‚¨çš„è¯·æ±‚ã€‚");
        setShowSettings(false);
    }
  };

  // Student Settings Modal
  const StudentSettingsModal = () => (
      <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 animate-in fade-in">
          <div className="bg-white rounded-xl w-96 p-6 shadow-2xl">
              <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Settings size={20} className="text-slate-700"/> è´¦æˆ·ä¸éšç§è®¾ç½®</h3>
              
              <div className="space-y-4">
                  <div className="p-3 bg-slate-50 rounded-lg border border-slate-100">
                      <div className="text-xs text-slate-500 uppercase font-bold mb-1">æ•°æ®ä¿ç•™ç­–ç•¥</div>
                      <div className="text-sm text-slate-800">åŸå§‹å¯¹è¯ä¿ç•™ <span className="font-bold text-indigo-600">{API_CONFIG.DATA_RETENTION_DAYS} å¤©</span></div>
                      <div className="text-xs text-slate-400 mt-1">åˆ°æœŸåè‡ªåŠ¨åˆ é™¤åŸå§‹å†…å®¹ï¼Œä»…ä¿ç•™åŒ¿åç»Ÿè®¡æ•°æ®ã€‚</div>
                  </div>

                  <div className="p-3 bg-slate-50 rounded-lg border border-slate-100">
                      <div className="text-xs text-slate-500 uppercase font-bold mb-1">å½“å‰ä½¿ç”¨æ¨¡å‹</div>
                      <div className="text-sm text-slate-800 font-mono">{API_CONFIG.DEFAULT_LLM_MODEL} (åå°æ‰˜ç®¡)</div>
                  </div>

                  <hr className="border-slate-100"/>

                  <button onClick={handleDataDeletionRequest} className="w-full py-2 bg-red-50 text-red-600 border border-red-100 rounded-lg text-sm font-bold hover:bg-red-100 transition-colors flex items-center justify-center gap-2">
                      <Trash2 size={16}/> ç”³è¯·å½»åº•åˆ é™¤æ•°æ®
                  </button>
              </div>

              <button onClick={() => setShowSettings(false)} className="mt-6 w-full py-2 bg-slate-800 text-white rounded-lg text-sm font-bold hover:bg-slate-700">å…³é—­</button>
          </div>
      </div>
  );

  const KnowledgeGraphView = () => (
    <div className="flex-1 bg-slate-50 flex items-center justify-center p-8 overflow-hidden relative">
      <div className="absolute top-4 left-4 bg-white/80 p-3 rounded-lg backdrop-blur text-sm border shadow-sm z-10">
        <h3 className="font-bold text-indigo-800 flex items-center gap-2"><Network size={16}/> AI çŸ¥è¯†å›¾è°±</h3>
        <p className="text-slate-500 text-xs">ç‚¹å‡»èŠ‚ç‚¹å‘ AI æé—®</p>
      </div>
      <svg viewBox="0 0 800 600" className="w-full h-full max-w-4xl max-h-[600px] border border-slate-200 bg-white rounded-2xl shadow-sm">
        {KNOWLEDGE_LINKS.map((link, i) => {
          const start = KNOWLEDGE_NODES.find(n => n.id === link.from);
          const end = KNOWLEDGE_NODES.find(n => n.id === link.to);
          return <line key={i} x1={start.x} y1={start.y} x2={end.x} y2={end.y} stroke="#cbd5e1" strokeWidth="2" />;
        })}
        {KNOWLEDGE_NODES.map((node) => (
          <g key={node.id} onClick={() => { setViewMode('chat'); sendMsg(`è¯·è¯¦ç»†è®²è§£ä¸€ä¸‹"${node.label}"çš„æ ¸å¿ƒçŸ¥è¯†ç‚¹ã€‚`); }} className="cursor-pointer hover:opacity-80 transition-opacity">
            <circle cx={node.x} cy={node.y} r={node.r} fill={node.color} className="shadow-lg drop-shadow-lg" />
            <text x={node.x} y={node.y} dy=".3em" textAnchor="middle" fill="white" fontSize="12" fontWeight="bold">{node.label}</text>
          </g>
        ))}
      </svg>
    </div>
  );

  return (
    <div className="flex h-screen bg-white font-sans text-gray-800 overflow-hidden relative">
      {showSettings && <StudentSettingsModal />}
      <aside className={`fixed inset-y-0 left-0 z-50 w-[260px] bg-[#000000] text-gray-100 flex flex-col transition-all duration-300 ${showHistory ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 ${!showHistory && 'md:!w-0 md:overflow-hidden'}`}>
        <div className="p-3 flex items-center justify-between">
          <button onClick={createNewSession} className="flex-1 flex items-center gap-2 px-3 py-2.5 rounded-lg hover:bg-[#212121] transition-colors text-sm text-white border border-transparent hover:border-white/10">
            <div className="bg-white text-black rounded-full p-0.5"><Plus size={14}/></div><span className="font-medium">æ–°å¯¹è¯</span>
          </button>
          <button onClick={() => setShowHistory(false)} className="p-2.5 hover:bg-[#212121] rounded-lg text-gray-400 hover:text-white ml-2"><LayoutDashboard size={18} className="rotate-90"/></button>
        </div>
        
        {/* New Feature Navigation */}
        <div className="px-3 py-2 space-y-1 border-b border-white/10 mb-2">
           <button onClick={() => setViewMode('graph')} className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm ${viewMode === 'graph' ? 'bg-indigo-600 text-white' : 'text-gray-400 hover:text-white hover:bg-[#212121]'}`}><Network size={16}/> çŸ¥è¯†å›¾è°±</button>
        </div>

        <div className="flex-1 overflow-y-auto px-2 py-2 space-y-4 custom-scrollbar">
           <div>{sessions.map(s => (<div key={s.id} onClick={() => { setCurrentSessionId(s.id); setViewMode('chat'); }} className={`group flex items-center gap-2 px-3 py-2.5 rounded-lg text-sm cursor-pointer relative overflow-hidden ${currentSessionId === s.id && viewMode === 'chat' ? 'bg-[#212121]' : 'hover:bg-[#212121]'}`}><MessageSquare size={16} className="text-gray-400 flex-shrink-0"/><span className="truncate flex-1 pr-6">{s.title}</span></div>))}</div>
        </div>
        {/* Settings Entry */}
        <div className="p-3 border-t border-white/10">
            <button onClick={() => setShowSettings(true)} className="flex items-center gap-3 w-full px-3 py-3 hover:bg-[#212121] rounded-lg transition-colors text-sm group">
                <div className="w-8 h-8 rounded bg-green-600 flex items-center justify-center text-white font-bold group-hover:scale-105 transition-transform">L</div>
                <div className="flex flex-col items-start text-left"><span className="font-medium">Student User</span><span className="text-xs text-gray-400 group-hover:text-white transition-colors">è®¾ç½®ä¸éšç§</span></div>
                <Settings size={14} className="ml-auto text-gray-500 group-hover:text-white"/>
            </button>
        </div>
      </aside>

      <main className="flex-1 flex flex-col min-w-0 bg-slate-50">
        <header className="h-14 flex items-center justify-between px-4 sticky top-0 z-10 bg-white/95 border-b border-gray-100">
           <div className="flex items-center">{!showHistory && <button onClick={() => setShowHistory(true)} className="p-2 mr-2 text-gray-500 hover:bg-gray-100 rounded-lg"><LayoutDashboard size={20} className="rotate-90"/></button>} <div className="relative"><button onClick={() => setShowModelMenu(!showModelMenu)} className="flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-gray-100 transition-colors text-gray-700 font-semibold text-lg">{mode.short} <ChevronDown size={16} className="text-gray-400"/></button>{showModelMenu && (<div className="absolute top-full left-0 mt-2 w-72 bg-white rounded-2xl shadow-xl border border-gray-100 p-2 z-50 animate-in fade-in zoom-in-95 duration-100"><div className="text-xs font-bold text-gray-400 px-3 py-2 uppercase">é€‰æ‹©å­¦ä¹ æ¨¡å¼</div>{LEARNING_MODES.map(m => (<button key={m.id} onClick={() => { setMode(m); setShowModelMenu(false); }} className={`w-full flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-gray-50 transition-colors text-left ${mode.id === m.id ? 'bg-gray-50' : ''}`}><div className={`p-2 rounded-lg ${m.id === mode.id ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'}`}><m.icon size={18}/></div><div><div className="font-medium text-gray-800">{m.name}</div><div className="text-xs text-gray-500">{m.desc}</div></div>{mode.id === m.id && <CheckCircle size={16} className="ml-auto text-black"/>}</button>))}</div>)}</div></div><div className="flex items-center gap-2"><button onClick={handleExportChat} className="p-2 text-gray-400 hover:text-black hover:bg-gray-100 rounded-full" title="å¯¼å‡ºç¬”è®°"><Download size={18}/></button><button onClick={() => setShowNotices(!showNotices)} className="relative p-2 text-gray-400 hover:text-black hover:bg-gray-100 rounded-full"><Bell size={18}/>{announcements.length > 0 && <span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border-2 border-white"></span>}</button></div>
        </header>

        {viewMode === 'chat' ? (
          <>
            <div className="flex-1 overflow-y-auto relative custom-scrollbar bg-slate-50">
              {messages.length === 0 ? (
                <div className="h-full flex flex-col items-center justify-center p-4">
                  <div className="mb-8 p-4 bg-white rounded-full shadow-sm border border-gray-100"><BrainCircuit size={48} className="text-gray-300" /></div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-2xl">{SUGGESTIONS.map((s, i) => (<button key={i} onClick={() => handleQuickPrompt(s.text)} className="p-4 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 text-left transition-colors flex items-center justify-between group"><div><div className="font-medium text-gray-700 text-sm">{s.text}</div><div className="text-xs text-gray-400">{s.sub}</div></div><div className="opacity-0 group-hover:opacity-100 transition-opacity bg-gray-100 p-1 rounded shadow-sm"><Send size={14} className="text-gray-400"/></div></button>))}</div>
                </div>
              ) : (
                <div className="flex flex-col pb-4 w-full max-w-3xl mx-auto pt-6">
                  {messages.map((m, i) => (
                    <div key={i} className={`w-full py-6 px-4 md:px-0 border-b border-gray-100/50`}>
                      <div className="flex gap-4 md:gap-6 max-w-3xl mx-auto">
                        <div className={`w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center ${m.role === 'user' ? 'bg-gray-200' : 'bg-green-500 text-white'}`}>{m.role === 'user' ? <User size={16} className="text-gray-600"/> : <Bot size={18}/>}</div>
                        <div className="relative flex-1 overflow-hidden">
                          <div className="font-bold text-sm mb-1 text-gray-900">{m.role === 'user' ? 'ä½ ' : API_CONFIG.STUDENT_APP_NAME}</div>
                          {m.attachment && (<div className="mb-3 inline-flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-xl max-w-xs shadow-sm">{m.attachment.type.startsWith('image') ? <img src={m.attachment.url} alt="é™„ä»¶" className="w-12 h-12 rounded object-cover"/> : <div className="w-10 h-10 bg-gray-100 rounded flex items-center justify-center border"><FileText size={20} className="text-gray-400"/></div>}<div className="flex flex-col overflow-hidden"><span className="text-sm font-medium truncate w-32">{m.attachment.name}</span><span className="text-xs text-gray-400">å·²ä¸Šä¼ </span></div></div>)}
                          {m.image && <div className="mb-3"><img src={m.image} alt="AI Generated" className="rounded-xl shadow-md max-w-sm"/></div>}
                          <div className="prose prose-slate prose-p:leading-relaxed text-gray-800 text-[15px]">{m.content}</div>
                          {m.privacyBlocked && <div className="mt-2 inline-flex items-center gap-1.5 text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded border border-orange-100"><ShieldAlert size={12} />å·²è‡ªåŠ¨æ‹¦æˆªå¹¶è„±æ•æ•æ„Ÿä¿¡æ¯</div>}
                          {m.role === 'ai' && (<div className="flex items-center gap-3 mt-2 opacity-100 transition-opacity"><button onClick={() => handlePlayAudio(m.content, i)} className={`hover:text-gray-600 flex items-center gap-1 ${audioPlaying === i ? 'text-green-600 font-bold' : 'text-gray-400'}`} title="æœ—è¯»">{audioPlaying === i ? <Square size={14}/> : <Volume2 size={14}/>}</button><button className="text-gray-400 hover:text-gray-600"><Copy size={14}/></button></div>)}
                        </div>
                      </div>
                    </div>
                  ))}
                  {isLoading && (<div className="w-full py-6 px-4 md:px-0"><div className="flex gap-4 md:gap-6 max-w-3xl mx-auto"><div className="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white"><Bot size={18}/></div><div className="flex items-center gap-2 mt-2"><div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div><div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-75"></div></div></div></div>)}
                  <div ref={messagesEndRef} className="h-12" />
                </div>
              )}
            </div>
            {/* Input Area */}
            <div className="p-4 bg-white">
              <div className="max-w-3xl mx-auto relative">
                {attachment && (<div className="absolute bottom-full left-0 mb-2 p-2 bg-white border border-gray-200 rounded-xl shadow-lg flex items-center gap-3 animate-in slide-in-from-bottom-2"><div className="w-8 h-8 bg-gray-100 rounded flex items-center justify-center text-gray-500">{attachment.type.startsWith('image') ? <ImageIcon size={16}/> : <FileText size={16}/>}</div><span className="text-sm text-gray-700 truncate max-w-[150px]">{attachment.name}</span><button onClick={() => setAttachment(null)} className="text-gray-400 hover:text-red-500"><X size={16}/></button></div>)}
                {showTools && (<div className="absolute bottom-full left-0 mb-3 bg-white/90 backdrop-blur-xl rounded-2xl shadow-xl border border-white/50 p-2 min-w-[200px] animate-in slide-in-from-bottom-2 fade-in duration-200 z-30"><div className="text-[10px] font-bold text-slate-400 px-3 py-2 uppercase tracking-wider">AI æ™ºèƒ½å·¥å…·ç®±</div><div className="space-y-1"><button onClick={() => handleAiTool('polish')} className="w-full flex items-center gap-3 px-3 py-2.5 text-sm text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition-colors text-left group"><div className="p-1.5 bg-indigo-100 text-indigo-600 rounded-lg group-hover:bg-indigo-200"><PenTool size={14}/></div> æ¶¦è‰²å½“å‰æ–‡æœ¬</button><button onClick={() => handleAiTool('grade')} className="w-full flex items-center gap-3 px-3 py-2.5 text-sm text-slate-600 hover:bg-red-50 hover:text-red-600 rounded-xl transition-colors text-left group"><div className="p-1.5 bg-red-100 text-red-600 rounded-lg group-hover:bg-red-200"><Highlighter size={14}/></div> ä½œæ–‡æ‰¹æ”¹</button><button onClick={() => handleAiTool('mindmap')} className="w-full flex items-center gap-3 px-3 py-2.5 text-sm text-slate-600 hover:bg-blue-50 hover:text-blue-600 rounded-xl transition-colors text-left group"><div className="p-1.5 bg-blue-100 text-blue-600 rounded-lg group-hover:bg-blue-200"><Network size={14}/></div> ç”ŸæˆçŸ¥è¯†å¯¼å›¾</button><button onClick={() => handleAiTool('suggest')} className="w-full flex items-center gap-3 px-3 py-2.5 text-sm text-slate-600 hover:bg-amber-50 hover:text-amber-600 rounded-xl transition-colors text-left group"><div className="p-1.5 bg-amber-100 text-amber-600 rounded-lg group-hover:bg-amber-200"><Lightbulb size={14}/></div> æ¨èæé—®çµæ„Ÿ</button></div></div>)}
                <div className="relative flex items-end border border-gray-300 rounded-2xl shadow-sm bg-white focus-within:ring-1 focus-within:ring-gray-400 focus-within:border-gray-400 transition-all overflow-hidden">
                  <button onClick={() => setShowTools(!showTools)} className={`p-3 text-gray-400 hover:text-gray-600 transition-colors ${showTools ? 'text-indigo-500' : ''}`} title="AIå·¥å…·"><Wand2 size={20} /></button>
                  <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileSelect} accept="image/*,.pdf,.doc,.docx,.txt"/>
                  <button onClick={() => fileInputRef.current?.click()} className="p-3 text-gray-400 hover:text-gray-600 transition-colors" title="ä¸Šä¼ é™„ä»¶"><Paperclip size={20} /></button>
                  <textarea ref={textareaRef} value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); } }} disabled={isLoading} rows={1} className="flex-1 max-h-[200px] py-3 px-0 bg-transparent border-none outline-none text-gray-800 placeholder-gray-400 text-base resize-none overflow-y-auto" placeholder={`ç»™ ${API_CONFIG.STUDENT_APP_NAME} å‘é€æ¶ˆæ¯...`}/>
                  <button onClick={handleVoiceInput} className={`p-3 transition-colors ${isRecording ? 'text-red-500 animate-pulse' : 'text-gray-400 hover:text-gray-600'}`} title={isRecording ? "æ­£åœ¨å¬..." : "è¯­éŸ³è¾“å…¥"}><Mic size={20} className={isRecording ? 'fill-red-500' : ''}/></button>
                  <button onClick={() => sendMsg()} disabled={isLoading || (!input.trim() && !attachment)} className={`p-2 m-2 rounded-lg transition-all duration-200 ${input.trim() || attachment ? 'bg-black text-white hover:bg-gray-800' : 'bg-gray-100 text-gray-300 cursor-not-allowed'}`}><Send size={16} /></button>
                </div>
                <div className="text-center mt-2 text-xs text-gray-400">{API_CONFIG.STUDENT_APP_NAME} å¯èƒ½ä¼šçŠ¯é”™ã€‚è¯·æ ¸å¯¹é‡è¦ä¿¡æ¯ã€‚</div>
              </div>
            </div>
          </>
        ) : viewMode === 'graph' ? (
          <KnowledgeGraphView />
        ) : null}
      </main>
    </div>
  );
};

// ==========================================
// part 3: ç®¡ç†å‘˜åå° (AdminDashboard) 
// ==========================================
const INITIAL_NODES = [{ id: 1, name: 'é¦™æ¸¯ HK-01 é«˜é€ŸèŠ‚ç‚¹', type: 'Vmess', ip: '47.102.xx.xx', status: 'åœ¨çº¿', latency: '45ms', load: '32%' }, { id: 2, name: 'æ—¥æœ¬ JP-Osaka å¤‡ç”¨', type: 'Shadowsocks', ip: '103.20.xx.xx', status: 'åœ¨çº¿', latency: '89ms', load: '12%' }];

// [ä¿®æ”¹] ç”¨æˆ·æ•°æ®ä¸å†ä½¿ç”¨å›ºå®š tokenLimitï¼Œæ”¹ä¸º 'Dynamic'
const INITIAL_USERS = [
  { id: 'STU_2024001', name: 'å¼ ä¸‰', class: 'é«˜ä¸‰(1)ç­', key: 'sk-lc-8921...', status: 'active', usage: '1.2M', tokenLimit: 'Dynamic', generatedAt: '2023-10-01', expiresAt: '2025-10-01T00:00:00' },
  { id: 'STU_2024002', name: 'æå››', class: 'é«˜ä¸‰(2)ç­', key: 'sk-lc-3342...', status: 'active', usage: '0.8M', tokenLimit: 'Dynamic', generatedAt: '2023-10-05', expiresAt: 'PERMANENT' }
];

const INITIAL_API_KEYS = [{ id: 1, provider: 'OpenAI', model: 'GPT-4o', alias: 'Primary-Production', keyMask: 'sk-...4f9a', balance: '$120.50', status: 'active', usage24h: '500k', weight: 10 }];
const INITIAL_LOGS = [{ id: 100, time: '10:45:00', user: 'System', ip: 'Localhost', action: 'éšç§æ‹¦æˆª', detail: 'æ‹¦æˆªæ•æ„Ÿæ•°æ®ï¼šæ‰‹æœºå· (Student: å¼ ä¸‰)', status: 'warning' }, { id: 101, time: '10:42:31', user: 'Admin', ip: '192.168.1.5', action: 'èŠ‚ç‚¹æ›´æ–°', detail: 'ä¿®æ”¹èŠ‚ç‚¹ JP-Osaka æƒé‡', status: 'success' }];
const INITIAL_FILES = [{ id: 1, name: 'è®ºè¯­Â·å­¦è€Œç¯‡è§£æ.pdf', size: '2.4 MB', type: 'PDF', date: '2023-10-15' }, { id: 2, name: 'é«˜ä¸‰æ•°å­¦å‡½æ•°è€ƒç‚¹.docx', size: '1.1 MB', type: 'DOCX', date: '2023-11-02' }];
const INITIAL_ANNOUNCEMENTS = [{ id: 1, title: 'ç³»ç»Ÿç»´æŠ¤é€šçŸ¥', content: 'å°†äºæœ¬å‘¨å…­å‡Œæ™¨ 2:00 è¿›è¡ŒèŠ‚ç‚¹æ‰©å®¹å‡çº§ï¼Œé¢„è®¡è€—æ—¶ 30 åˆ†é’Ÿã€‚', date: '2023-11-20' }, { id: 2, title: 'æ–°åŠŸèƒ½ä¸Šçº¿', content: 'AI å¯¼å¸ˆç°åœ¨æ”¯æŒâ€œä½œæ–‡æ¶¦è‰²â€åŠŸèƒ½å•¦ï¼Œå¿«å»è¯•è¯•å§ï¼', date: '2023-11-18' }];
const ALERT_LOGS = [
  { type: 'warning', msg: 'OpenAI API å“åº”å»¶è¿Ÿè¿‡é«˜', time: '2m ago' },
  { type: 'error', msg: 'æ£€æµ‹åˆ°é«˜é¢‘éšç§æ³„éœ²å°è¯• (IP: 192.168.x.x)', time: '15m ago' },
  { type: 'info', msg: 'ç³»ç»Ÿè‡ªåŠ¨æ‰©å®¹å®Œæˆ', time: '1h ago' },
];

export default function AdminDashboard() {
  const [currentView, setCurrentView] = useState('dashboard');
  const [nodes, setNodes] = useState(INITIAL_NODES);
  const [users, setUsers] = useState(INITIAL_USERS);
  const [apiKeys, setApiKeys] = useState(INITIAL_API_KEYS);
  const [logs, setLogs] = useState(INITIAL_LOGS);
  const [knowledgeFiles, setKnowledgeFiles] = useState(INITIAL_FILES);
  const [announcements, setAnnouncements] = useState(INITIAL_ANNOUNCEMENTS);
  
  const [serverConfig, setServerConfig] = useState({ cpu: 'Intel Xeon Platinum 8375C (32 vCPU)', ram: '64 GB ECC DDR4', gpu: 'NVIDIA A10G (24GB)', disk: '2 TB NVMe SSD', bandwidth: '1 Gbps' });
  const [serverStats, setServerStats] = useState({ cpu: 45, ram: 60, gpu: 20, temp: 42 });
  const [privacyRules, setPrivacyRules] = useState({ phone: true, email: true, idCard: true, bankCard: false, studentId: true, studentName: true, modelLeak: true });
  const [customKeywords, setCustomKeywords] = useState(['å†…éƒ¨é¡¹ç›®', 'ProjectX']); 
  const [newKeyword, setNewKeyword] = useState('');
  const [privacyStats, setPrivacyStats] = useState({ blockedCount: 12, lastBlocked: '10åˆ†é’Ÿå‰' });
  
  const [showScanner, setShowScanner] = useState(false);
  const [showStudentPreview, setShowStudentPreview] = useState(false);
  const [isSidebarOpen, setSidebarOpen] = useState(true);
  const [showUserModal, setShowUserModal] = useState(false);
  const [newUserForm, setNewUserForm] = useState({ name: '', class: '', autoName: true, durationDays: 365, tokenLimit: 'Dynamic' }); 
  const [newAnnouncement, setNewAnnouncement] = useState('');
  const [isDraftingNotice, setIsDraftingNotice] = useState(false);
  const [showApiModal, setShowApiModal] = useState(false);
  const [newApiForm, setNewApiForm] = useState({ provider: 'OpenAI', model: '', key: '', alias: '', baseUrl: '' });

  const [showExtendModal, setShowExtendModal] = useState(false);
  const [targetUserForExtension, setTargetUserForExtension] = useState(null);
  const [extensionDuration, setExtensionDuration] = useState(30); 
  const [showNodeModal, setShowNodeModal] = useState(false);
  const [newNodeForm, setNewNodeForm] = useState({ name: '', type: 'Vmess', ip: '', port: '' });
  const [wafRules, setWafRules] = useState({ sql: true, xss: true, ddos: true, bot: false });

  const [showUserLogsModal, setShowUserLogsModal] = useState(false);
  const [targetUserForLogs, setTargetUserForLogs] = useState(null);

  const [showEditUserModal, setShowEditUserModal] = useState(false);
  const [editingUser, setEditingUser] = useState(null);

  const [riskQps, setRiskQps] = useState(60);
  const [riskIp, setRiskIp] = useState(true);
  const [riskUser, setRiskUser] = useState(true);

  const [vaultStatus, setVaultStatus] = useState('locked'); 
  const [encryptInput, setEncryptInput] = useState('');
  const [encryptedOutput, setEncryptedOutput] = useState('');

  const [aiAnalysis, setAiAnalysis] = useState(null);
  const [isAnalyzingLogs, setIsAnalyzingLogs] = useState(false);
  const [aiNodeAnalysis, setAiNodeAnalysis] = useState(null);
  const [isOptimizingNodes, setIsOptimizingNodes] = useState(false);
  const [aiServerAnalysis, setAiServerAnalysis] = useState(null);
  const [isAnalyzingServer, setIsAnalyzingServer] = useState(false);
  const [aiFileAnalysis, setAiFileAnalysis] = useState(null);

  // [æ–°å¢] Token åŠ¨æ€è°ƒåº¦æ± é…ç½®
  const [tokenPoolConfig, setTokenPoolConfig] = useState({
    totalPoolSize: 100000000, // 1äº¿ Token
    currentUsage: 45000000, // å½“å‰å·²ç”¨
    poolStatus: 'normal', // normal, peak, idle
    peakCompressionRatio: 0.3, // é«˜å³°å‹ç¼© 30%
    idleReleaseRatio: 0.5, // ä½å³°é‡Šæ”¾ 50%
  });

  // [æ–°å¢] å¼‚å¸¸è¡Œä¸ºç†”æ–­é…ç½®
  const [circuitBreakerConfig, setCircuitBreakerConfig] = useState({
    autoFusion: true, // è‡ªåŠ¨ç†”æ–­ç«¯å£
    autoThrottle: true, // è‡ªåŠ¨é™é€Ÿ
    freezeDuration: 10, // å†»ç»“æ—¶é•¿ (åˆ†é’Ÿ)
    triggerThreshold: 80, // è§¦å‘é˜ˆå€¼ (é£é™©åˆ†)
  });

  useEffect(() => { const i = setInterval(() => setServerStats({ cpu: Math.random()*100|0, ram: Math.random()*100|0, gpu: Math.random()*100|0, temp: 40+Math.random()*20|0 }), 3000); return () => clearInterval(i); }, []);

  // [æ–°å¢] æ¨¡æ‹Ÿ Token æ± åŠ¨æ€å˜åŒ–
  useEffect(() => {
    const timer = setInterval(() => {
      setTokenPoolConfig(prev => {
        // æ¨¡æ‹Ÿè´Ÿè½½æ³¢åŠ¨
        const newUsage = prev.currentUsage + (Math.random() - 0.5) * 500000;
        const usageRatio = newUsage / prev.totalPoolSize;
        let status = 'normal';
        if (usageRatio > 0.8) status = 'peak'; // é«˜å³°
        else if (usageRatio < 0.2) status = 'idle'; // ä½å³°
        return { ...prev, currentUsage: newUsage, poolStatus: status };
      });
    }, 2000);
    return () => clearInterval(timer);
  }, []);

  const addLog = (user, action, detail, status = 'success') => setLogs(p => [{ id: Date.now(), time: new Date().toLocaleTimeString(), user, action, detail, status }, ...p]);
  const handlePrivacyTrigger = (items) => { setPrivacyStats(p => ({ blockedCount: p.blockedCount + 1, lastBlocked: 'åˆšåˆš' })); addLog('System', 'Privacy Block', `æ‹¦æˆªæ•æ„Ÿä¿¡æ¯: ${items.join(', ')}`, 'warning'); };
  const handleDeleteUser = (id) => { if(window.confirm('åˆ é™¤?')) setUsers(users.filter(u=>u.id!==id)); };
  const toggleUserStatus = (id) => setUsers(users.map(u=>u.id===id?{...u, status: u.status==='active'?'banned':'active'}:u));
  const openAddUserModal = () => { setNewUserForm({ name: '', class: '', autoName: true, durationDays: 365, tokenLimit: 'Dynamic' }); setShowUserModal(true); };
  
  const confirmAddUser = () => { const id = `STU_${Date.now()}`; let exp = 'PERMANENT'; if(newUserForm.durationDays!=='PERMANENT'){ const d = new Date(); d.setDate(d.getDate() + Number(newUserForm.durationDays)); exp = d.toISOString(); } setUsers([{ id, name: newUserForm.name||'Student', class: newUserForm.class, key: 'sk-new', status: 'active', usage: '0', tokenLimit: 'Dynamic', generatedAt: new Date().toLocaleDateString(), expiresAt: exp }, ...users]); setShowUserModal(false); };
  const handleOpenExtendModal = (u) => { setTargetUserForExtension(u); setExtensionDuration(30); setShowExtendModal(true); };
  const handleExtendUser = () => { setUsers(users.map(u => u.id === targetUserForExtension.id ? { ...u, expiresAt: extensionDuration === 'PERMANENT' ? 'PERMANENT' : new Date(new Date(u.expiresAt === 'PERMANENT' ? Date.now() : u.expiresAt).getTime() + extensionDuration * 86400000).toISOString() } : u)); setShowExtendModal(false); };
  
  const handleViewUserLogs = (user) => {
    setTargetUserForLogs(user);
    setShowUserLogsModal(true);
  };

  const handleOpenEditUserModal = (user) => {
    setEditingUser({...user});
    setShowEditUserModal(true);
  };

  const handleSaveUser = () => {
    setUsers(users.map(u => u.id === editingUser.id ? editingUser : u));
    setShowEditUserModal(false);
    addLog('Admin', 'æƒé™å˜æ›´', `ä¿®æ”¹ç”¨æˆ· ${editingUser.name} æƒé™ (é¢åº¦: ${editingUser.tokenLimit})`);
  };

  // Export Users Function
  const handleExportUsers = () => {
      const csvContent = "data:text/csv;charset=utf-8," 
          + "ID,Name,Class,Status,Usage,Limit,Expires\n"
          + users.map(u => `${u.id},${u.name},${u.class},${u.status},${u.usage},${u.tokenLimit},${u.expiresAt}`).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `student_data_export_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      addLog('Admin', 'æ•°æ®å¯¼å‡º', `å¯¼å‡º ${users.length} æ¡ç”¨æˆ·æ•°æ®`, 'success');
  };

  const handleSimulateEncryption = () => {
    if (!encryptInput) return;
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()";
    let result = "AES-256-GCM::";
    for (let i = 0; i < encryptInput.length * 2; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    setEncryptedOutput(result);
  };

  const handleDeleteApiKey = (id) => setApiKeys(apiKeys.filter(k=>k.id!==id));
  const confirmAddApiKey = () => { setApiKeys([...apiKeys, { id: Date.now(), ...newApiForm, balance: 'Active', status: 'active', usage24h: '0', weight: 10 }]); setShowApiModal(false); };
  const handleScanQRCode = () => { setShowScanner(true); setTimeout(() => { setShowScanner(false); setNodes([...nodes, { id: Date.now(), name: 'æ‰«ç èŠ‚ç‚¹', type: 'Vmess', ip: '1.1.1.1', status: 'åœ¨çº¿', latency: '50ms', load: '0%' }]); }, 1000); };
  const confirmAddNode = () => { setNodes([...nodes, { id: Date.now(), ...newNodeForm, status: 'åœ¨çº¿', latency: '10ms', load: '0%' }]); setShowNodeModal(false); };
  const handlePostAnnouncement = () => { setAnnouncements([{ id: Date.now(), title: 'é€šçŸ¥', content: newAnnouncement, date: 'åˆšåˆš' }, ...announcements]); setNewAnnouncement(''); };
  
  const handleAiLogAnalysis = async () => {
    setIsAnalyzingLogs(true);
    const analysis = await callUnifiedLLM([], 'general', 'analyze_logs', logs);
    setAiAnalysis(analysis);
    setIsAnalyzingLogs(false);
  };
  const handleAiNodeOptimization = () => { setIsOptimizingNodes(true); setTimeout(() => { setAiNodeAnalysis('AIå»ºè®®ï¼šèŠ‚ç‚¹è´Ÿè½½å‡è¡¡è‰¯å¥½ã€‚'); setIsOptimizingNodes(false); }, 1000); };
  const handleAiServerAnalysis = () => { setIsAnalyzingServer(true); setTimeout(() => { setAiServerAnalysis('AIè¯Šæ–­æŠ¥å‘Šï¼šCPUè´Ÿè½½å¹³ç¨³ï¼Œå†…å­˜ä½¿ç”¨ç‡ç•¥é«˜ï¼ˆå»ºè®®å…³æ³¨ Java è¿›ç¨‹ï¼‰ï¼ŒGPU æ¸©åº¦æ­£å¸¸ã€‚æ— éœ€æ‰©å®¹ã€‚'); setIsAnalyzingServer(false); }, 2000); };
  const handleAiFileAnalysis = (f) => { setAiFileAnalysis({ id: f.id, content: 'AIæ­£åœ¨ç”Ÿæˆæ‘˜è¦...', loading: true }); setTimeout(() => { setAiFileAnalysis({ id: f.id, content: `AI æ™ºèƒ½æ‘˜è¦ï¼šè¿™ä»½æ–‡æ¡£ä¸»è¦è®²è§£äº†${f.name.split('.')[0]}çš„æ ¸å¿ƒæ¦‚å¿µï¼Œé€‚åˆé«˜ä¸‰å¤ä¹ ä½¿ç”¨ã€‚é‡ç‚¹åŒ…å«äº†è€ƒç‚¹è§£æä¸ä¾‹é¢˜åˆ†æã€‚`, loading: false })}, 1500); };
  const handleAiDraftAnnouncement = async () => {
    setIsDraftingNotice(true);
    const draft = await callUnifiedLLM([], 'general', 'draft_announcement');
    setNewAnnouncement(draft);
    setIsDraftingNotice(false);
  };
  
  const addCustomKeyword = () => { if(newKeyword.trim() && !customKeywords.includes(newKeyword.trim())) { setCustomKeywords([...customKeywords, newKeyword.trim()]); setNewKeyword(''); } };
  const removeCustomKeyword = (kw) => setCustomKeywords(customKeywords.filter(k => k !== kw));

  // [æ–°å¢] æ¨¡æ‹Ÿè§¦å‘ç†”æ–­
  const handleSimulateBreaker = () => {
    if(!circuitBreakerConfig.autoFusion) return alert("è¯·å…ˆå¼€å¯è‡ªåŠ¨ç†”æ–­åŠŸèƒ½");
    addLog('System', 'Circuit Breaker', `æ£€æµ‹åˆ°å¼‚å¸¸æµé‡ (QPS > ${riskQps})ï¼Œè§¦å‘ ${circuitBreakerConfig.freezeDuration} åˆ†é’Ÿå°ç¦`, 'error');
    alert(`ã€ç³»ç»Ÿè­¦å‘Šã€‘\n\nå¼‚å¸¸è¡Œä¸ºç†”æ–­å™¨å·²è§¦å‘ï¼\n\n- ç«¯å£ï¼šå·²ç‰©ç†åˆ‡æ–­ (Port Fusion)\n- ç­–ç•¥ï¼šè‡ªåŠ¨é™é€Ÿ (Auto Throttle)\n- æƒ©ç½šï¼šè´¦æˆ· STU_Simulate å†»ç»“ ${circuitBreakerConfig.freezeDuration} åˆ†é’Ÿ`);
  };

  if (showStudentPreview) return <StudentApp onExitPreview={() => setShowStudentPreview(false)} privacyRules={privacyRules} onPrivacyTrigger={handlePrivacyTrigger} announcements={announcements} knowledgeFiles={knowledgeFiles} customKeywords={customKeywords} />;

  // ... (AddUserM, ExtendM, EditUserM, AddNodeM, ScannerM, AddApiM components remain the same) ...
  const AddUserM = () => (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50"><div className="bg-white p-6 rounded-xl w-96 space-y-4"><h3 className="font-bold">æ·»åŠ ç”¨æˆ·</h3><input className="w-full border p-2 rounded" placeholder="å§“å" value={newUserForm.name} onChange={e=>setNewUserForm({...newUserForm, name:e.target.value})}/><select className="w-full border p-2 rounded" value={newUserForm.class} onChange={e=>setNewUserForm({...newUserForm, class:e.target.value})}><option>é»˜è®¤ç­çº§</option><option>é«˜ä¸‰(1)</option></select><div className="flex gap-2 items-center"><input type="number" className="w-full border p-2 rounded" placeholder="æœ‰æ•ˆå¤©æ•°" value={newUserForm.durationDays} onChange={e=>setNewUserForm({...newUserForm, durationDays:e.target.value})}/><span>å¤©</span></div><div className="flex gap-2 items-center"><span className="text-sm font-bold w-24">Token é¢åº¦:</span><input disabled className="flex-1 border p-2 rounded bg-slate-100 text-slate-500" value="Dynamic (Auto)" /></div><div className="flex gap-2"><button onClick={()=>setShowUserModal(false)} className="flex-1 border p-2 rounded">å–æ¶ˆ</button><button onClick={confirmAddUser} className="flex-1 bg-indigo-600 text-white p-2 rounded">ç¡®å®š</button></div></div></div>);
  const ExtendM = () => (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50"><div className="bg-white p-6 rounded-xl w-96 space-y-4"><h3 className="font-bold">ç»­æœŸ: {targetUserForExtension?.name}</h3><div className="flex gap-2 items-center"><input type="number" className="w-full border p-2 rounded" value={extensionDuration} onChange={e=>setExtensionDuration(e.target.value)}/><span>å¤©</span></div><div className="flex gap-2"><button onClick={()=>setShowExtendModal(false)} className="flex-1 border p-2 rounded">å–æ¶ˆ</button><button onClick={handleExtendUser} className="flex-1 bg-indigo-600 text-white p-2 rounded">ç¡®å®š</button></div></div></div>);
  const EditUserM = () => (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="bg-white p-6 rounded-xl w-96 space-y-4">
        <h3 className="font-bold flex items-center gap-2"><Settings size={18}/> ç¼–è¾‘ç”¨æˆ·æƒé™</h3>
        <div><label className="text-xs font-bold text-slate-500 mb-1 block">å§“å</label><input className="w-full border p-2 rounded" value={editingUser.name} onChange={e=>setEditingUser({...editingUser, name:e.target.value})}/></div>
        <div><label className="text-xs font-bold text-slate-500 mb-1 block">ç­çº§</label><input className="w-full border p-2 rounded" value={editingUser.class} onChange={e=>setEditingUser({...editingUser, class:e.target.value})}/></div>
        <div><label className="text-xs font-bold text-slate-500 mb-1 block">Token é¢åº¦é™åˆ¶ (åŠ¨æ€è°ƒåº¦æ¨¡å¼å·²æ¥ç®¡)</label><input disabled className="w-full border p-2 rounded bg-slate-100 text-slate-500" value="Dynamic Allocation Active" /></div>
        <div className="flex gap-2 mt-4"><button onClick={()=>setShowEditUserModal(false)} className="flex-1 border p-2 rounded hover:bg-slate-50">å–æ¶ˆ</button><button onClick={handleSaveUser} className="flex-1 bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700">ä¿å­˜ä¿®æ”¹</button></div>
      </div>
    </div>
  );
  const AddNodeM = () => (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50"><div className="bg-white p-6 rounded-xl w-96 space-y-4"><h3 className="font-bold">æ‰‹åŠ¨æ·»åŠ èŠ‚ç‚¹</h3><input className="w-full border p-2 rounded" placeholder="åç§°" value={newNodeForm.name} onChange={e=>setNewNodeForm({...newNodeForm, name:e.target.value})}/><input className="w-full border p-2 rounded" placeholder="IP/åŸŸå" value={newNodeForm.ip} onChange={e=>setNewNodeForm({...newNodeForm, ip:e.target.value})}/><div className="flex gap-2"><button onClick={()=>setShowNodeModal(false)} className="flex-1 border p-2 rounded">å–æ¶ˆ</button><button onClick={confirmAddNode} className="flex-1 bg-indigo-600 text-white p-2 rounded">ç¡®å®š</button></div></div></div>);
  const ScannerM = () => (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80"><div className="bg-slate-900 p-8 rounded-xl text-center"><div className="w-48 h-48 bg-slate-800 mx-auto flex items-center justify-center mb-4"><QrCode className="text-slate-500" size={48}/></div><p className="text-white mb-4">è¯·æ‰«æèŠ‚ç‚¹äºŒç»´ç </p><button onClick={()=>setShowScanner(false)} className="text-slate-400">å–æ¶ˆ</button></div></div>);
  const AddApiM = () => (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50"><div className="bg-white p-6 rounded-xl w-96 space-y-4"><h3 className="font-bold">æ·»åŠ  API å¯†é’¥</h3><select className="w-full border p-2 rounded" value={newApiForm.provider} onChange={e=>setNewApiForm({...newApiForm, provider:e.target.value})}><option value="OpenAI">OpenAI</option><option value="Google">Google (Gemini)</option><option value="Anthropic">Anthropic</option></select><input className="w-full border p-2 rounded" placeholder="API Key" value={newApiForm.key} onChange={e=>setNewApiForm({...newApiForm, key:e.target.value})}/><input className="w-full border p-2 rounded" placeholder="Base URL (å¯é€‰)" value={newApiForm.baseUrl} onChange={e=>setNewApiForm({...newApiForm, baseUrl:e.target.value})}/><div className="flex gap-2"><button onClick={()=>setShowApiModal(false)} className="flex-1 border p-2 rounded">å–æ¶ˆ</button><button onClick={confirmAddApiKey} className="flex-1 bg-indigo-600 text-white p-2 rounded">æ·»åŠ </button></div></div></div>);
  const UserLogsM = () => { /* Log Modal implementation (same as before) */ return <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50"><div className="bg-white p-8 rounded-xl">æ—¥å¿—æŸ¥çœ‹å™¨... <button onClick={()=>setShowUserLogsModal(false)}>å…³é—­</button></div></div>; }; // Placeholder for brevity, real impl in previous step

  // Render Content
  const renderContent = () => {
    switch (currentView) {
      case 'dashboard': return (
        <div className="space-y-6">
          {/* New Retention Policy Card */}
          <div className="bg-indigo-50 border border-indigo-100 p-4 rounded-xl flex items-center justify-between">
              <div className="flex items-center gap-3">
                  <div className="p-2 bg-indigo-100 rounded-lg text-indigo-600"><Clock size={20}/></div>
                  <div>
                      <h3 className="font-bold text-indigo-900 text-sm">å…¨å±€æ•°æ®ä¿ç•™ç­–ç•¥ç”Ÿæ•ˆä¸­</h3>
                      <p className="text-xs text-indigo-700">åŸå§‹å¯¹è¯æ•°æ®ä¿ç•™ <span className="font-bold">{API_CONFIG.DATA_RETENTION_DAYS} å¤©</span>ï¼Œåˆ°æœŸè‡ªåŠ¨ç²‰ç¢ã€‚ç»Ÿè®¡æ•°æ®æ°¸ä¹…ä¿ç•™ã€‚</p>
                  </div>
              </div>
              <span className="text-xs font-mono bg-white px-2 py-1 rounded text-indigo-600 border border-indigo-200">Policy: AUTO_PURGE</span>
          </div>

          {/* [æ–°å¢] Token åŠ¨æ€è°ƒåº¦æ± é¢æ¿ */}
          <div className="bg-white p-6 rounded-xl border border-slate-100 shadow-sm relative overflow-hidden">
             <div className="flex justify-between items-start mb-4 relative z-10">
                <div>
                   <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Gauge className="text-blue-600"/> Token åŠ¨æ€è°ƒåº¦ä¸­å°</h3>
                   <p className="text-xs text-slate-400 mt-1">å…¨å±€æ€»æˆæƒæ± : <span className="font-mono text-slate-600 font-bold">{(tokenPoolConfig.totalPoolSize / 1000000).toFixed(0)}M</span> Tokens</p>
                </div>
                <div className={`px-3 py-1 rounded-full text-xs font-bold border flex items-center gap-2 ${tokenPoolConfig.poolStatus === 'peak' ? 'bg-orange-50 text-orange-600 border-orange-200' : tokenPoolConfig.poolStatus === 'idle' ? 'bg-green-50 text-green-600 border-green-200' : 'bg-slate-50 text-slate-600 border-slate-200'}`}>
                   {tokenPoolConfig.poolStatus === 'peak' ? <TrendingUp size={12}/> : <Activity size={12}/>}
                   {tokenPoolConfig.poolStatus === 'peak' ? 'é«˜å³°æ‹¥å µ (è‡ªåŠ¨å‹ç¼©)' : tokenPoolConfig.poolStatus === 'idle' ? 'ä½å³°é—²ç½® (ç®—åŠ›é‡Šæ”¾)' : 'è´Ÿè½½æ­£å¸¸'}
                </div>
             </div>
             
             {/* Visualization Bar */}
             <div className="relative h-8 bg-slate-100 rounded-lg overflow-hidden mb-4">
                <div style={{width: `${(tokenPoolConfig.currentUsage / tokenPoolConfig.totalPoolSize) * 100}%`}} className={`h-full transition-all duration-1000 flex items-center justify-end px-2 ${tokenPoolConfig.poolStatus === 'peak' ? 'bg-orange-500' : 'bg-blue-500'}`}>
                    <span className="text-[10px] text-white font-bold font-mono">{(tokenPoolConfig.currentUsage / 1000000).toFixed(1)}M Used</span>
                </div>
                <div className="absolute top-0 left-0 w-full h-full flex items-center justify-between px-3 pointer-events-none">
                   <div className="h-full border-r border-slate-300/50 w-[30%]"></div>
                   <div className="h-full border-r border-slate-300/50 w-[30%]"></div>
                </div>
             </div>

             <div className="grid grid-cols-3 gap-4 text-center">
                <div className="p-3 bg-slate-50 rounded-lg">
                   <div className="text-xs text-slate-500 mb-1">å½“å‰åˆ†é…ç­–ç•¥</div>
                   <div className="font-bold text-slate-800 text-sm">{tokenPoolConfig.poolStatus === 'peak' ? `å•ç”¨æˆ·é™æµ -${tokenPoolConfig.peakCompressionRatio*100}%` : tokenPoolConfig.poolStatus === 'idle' ? `é¢åº¦é‡Šæ”¾ +${tokenPoolConfig.idleReleaseRatio*100}%` : 'æ ‡å‡†åˆ†é…'}</div>
                </div>
                <div className="p-3 bg-slate-50 rounded-lg">
                   <div className="text-xs text-slate-500 mb-1">æ€»æ± æˆæƒ</div>
                   <input className="w-full bg-transparent text-center font-bold text-sm border-b border-dashed border-slate-300 focus:outline-none focus:border-blue-500" defaultValue="100,000,000"/>
                </div>
                <div className="p-3 bg-slate-50 rounded-lg">
                   <div className="text-xs text-slate-500 mb-1">é¢„ä¼°å‰©ä½™æ—¶é•¿</div>
                   <div className="font-bold text-green-600 text-sm">~14.2 Days</div>
                </div>
             </div>
          </div>

          <div className="grid grid-cols-4 gap-6">{[{l:'æ€»ç”¨æˆ·',v:users.length,c:'text-slate-800'},{l:'éšç§æ‹¦æˆª',v:privacyStats.blockedCount,c:'text-rose-600'},{l:'ç³»ç»Ÿè´Ÿè½½',v:serverStats.cpu+'%',c:'text-amber-500'},{l:'æˆæœ¬',v:'Â¥342',c:'text-slate-800'}].map((i,k)=>(<div key={k} className="bg-white p-6 rounded-xl border border-slate-100 shadow-sm"><div className="text-xs font-bold text-slate-500 uppercase">{i.l}</div><div className={`text-3xl font-bold mt-2 ${i.c}`}>{i.v}</div></div>))}</div>
          <div className="grid grid-cols-3 gap-6"><div className="col-span-2 bg-white p-6 rounded-xl border border-slate-100"><h3 className="font-bold mb-4">æ‹¦æˆªè¶‹åŠ¿</h3><div className="h-48 flex items-end gap-1">{[2,5,3,8,4,6,2,9,5,3,4,6,8,5,2,4,6,3,7,5].map((h,i)=>(<div key={i} style={{height:h*10+'%'}} className="flex-1 bg-indigo-50 hover:bg-indigo-500 rounded-t transition-colors"></div>))}</div></div><div className="bg-white p-6 rounded-xl border border-slate-100"><h3 className="font-bold mb-4">å‘å¸ƒå…¬å‘Š</h3><textarea className="w-full border rounded-lg p-2 h-24 mb-2" value={newAnnouncement} onChange={e=>setNewAnnouncement(e.target.value)}></textarea><div className="flex gap-2"><button onClick={handleAiDraftAnnouncement} className="flex-1 bg-slate-100 text-indigo-600 rounded text-sm font-bold flex items-center justify-center gap-1 hover:bg-indigo-50">{isDraftingNotice?<RefreshCw className="animate-spin" size={14}/>:<Sparkles size={14}/>} AIèµ·è‰</button><button onClick={handlePostAnnouncement} className="flex-1 bg-indigo-600 text-white rounded text-sm font-bold hover:bg-indigo-700">å‘å¸ƒ</button></div></div></div>
        </div>
      );
      case 'users': return (
        <div className="bg-white p-6 rounded-xl border border-slate-100">
          <div className="flex justify-between mb-4">
              <h3 className="font-bold">ç”¨æˆ·ç®¡ç†</h3>
              <div className="flex gap-2">
                  <button onClick={handleExportUsers} className="bg-white border border-slate-200 text-slate-700 px-3 py-1.5 rounded text-sm flex items-center gap-1 hover:bg-slate-50"><FileJson size={14}/> å¯¼å‡ºæ•°æ®</button>
                  <button onClick={openAddUserModal} className="bg-indigo-600 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1"><Plus size={14}/> æ·»åŠ å­¦ç”Ÿ</button>
              </div>
          </div>
          <table className="w-full text-sm text-left"><thead><tr className="border-b text-slate-500"><th className="pb-2">ID</th><th className="pb-2">å§“å</th><th className="pb-2">çŠ¶æ€</th><th className="pb-2">Token é…é¢æ¨¡å¼</th><th className="pb-2">å‰©ä½™æœ‰æ•ˆæœŸ</th><th className="pb-2 text-right">æ“ä½œ</th></tr></thead><tbody>{users.map(u=>(<tr key={u.id} className="border-b last:border-0 hover:bg-slate-50"><td className="py-3 font-mono text-xs">{u.id}</td><td className="py-3">{u.name}</td><td className="py-3"><span className={`px-2 py-0.5 rounded text-xs ${u.status==='active'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>{u.status==='active'?'æ­£å¸¸':'å°ç¦'}</span></td>
          <td className="py-3 font-mono text-xs">
             <span className={`px-2 py-1 rounded border ${tokenPoolConfig.poolStatus === 'peak' ? 'bg-orange-50 text-orange-600 border-orange-200' : 'bg-blue-50 text-blue-600 border-blue-200'}`}>
                {tokenPoolConfig.poolStatus === 'peak' ? 'Peak Limit (Low)' : 'Dynamic (Auto)'}
             </span>
          </td>
          <td className="py-3"><CountdownTimer expiresAt={u.expiresAt} onExpire={()=>toggleUserStatus(u.id)}/></td><td className="py-3 text-right flex justify-end gap-2"><button onClick={()=>handleViewUserLogs(u)} className="text-blue-600 bg-blue-50 p-1.5 rounded hover:bg-blue-100" title="æŸ¥çœ‹è°ƒç”¨æ—¥å¿—"><Activity size={14}/></button><button onClick={()=>handleOpenEditUserModal(u)} className="text-slate-600 bg-slate-100 p-1.5 rounded hover:bg-slate-200" title="æƒé™ç®¡ç†"><Sliders size={14}/></button><button onClick={()=>handleOpenExtendModal(u)} className="text-indigo-600 bg-indigo-50 p-1.5 rounded hover:bg-indigo-100" title="ç»­æœŸ"><Clock size={14}/></button><button onClick={()=>handleDeleteUser(u.id)} className="text-red-600 bg-red-50 p-1.5 rounded hover:bg-red-100"><Trash2 size={14}/></button></td></tr>))}</tbody></table>
        </div>
      );
      case 'security': return (
        <div className="space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
             {/* Security Center - L3-L7 WAF */}
             <div className="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                <div className="flex items-center justify-between mb-6">
                   <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><ShieldCheck className="text-emerald-500"/> WAF é˜²æŠ¤ä¸­å¿ƒ</h3>
                   <span className="px-2 py-1 bg-emerald-50 text-emerald-600 text-xs font-bold rounded-md border border-emerald-100 flex items-center gap-1"><Activity size={10} className="animate-pulse"/> ç³»ç»Ÿæ­£å¸¸è¿è¡Œ</span>
                </div>
                
                <div className="space-y-4">
                  <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                     <div>
                        <div className="font-bold text-sm text-slate-700">SQL æ³¨å…¥æ‹¦æˆª</div>
                        <div className="text-xs text-slate-400">æ‹¦æˆªæ¶æ„æ•°æ®åº“æŸ¥è¯¢è¯·æ±‚</div>
                     </div>
                     <button onClick={()=>setWafRules({...wafRules, sql: !wafRules.sql})} className={`w-10 h-5 rounded-full relative transition-colors ${wafRules.sql?'bg-emerald-500':'bg-slate-300'}`}><div className={`w-3 h-3 bg-white rounded-full absolute top-1 transition-all ${wafRules.sql?'right-1':'left-1'}`}></div></button>
                  </div>
                  <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                     <div>
                        <div className="font-bold text-sm text-slate-700">XSS è·¨ç«™è„šæœ¬é˜²æŠ¤</div>
                        <div className="text-xs text-slate-400">è¿‡æ»¤æ¶æ„è„šæœ¬è¾“å…¥</div>
                     </div>
                     <button onClick={()=>setWafRules({...wafRules, xss: !wafRules.xss})} className={`w-10 h-5 rounded-full relative transition-colors ${wafRules.xss?'bg-emerald-500':'bg-slate-300'}`}><div className={`w-3 h-3 bg-white rounded-full absolute top-1 transition-all ${wafRules.xss?'right-1':'left-1'}`}></div></button>
                  </div>
                  <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                     <div>
                        <div className="font-bold text-sm text-slate-700">DDoS æµé‡æ¸…æ´—</div>
                        <div className="text-xs text-slate-400">è‡ªåŠ¨è¯†åˆ«å¹¶æ¸…æ´—å¼‚å¸¸æµé‡</div>
                     </div>
                     <button onClick={()=>setWafRules({...wafRules, ddos: !wafRules.ddos})} className={`w-10 h-5 rounded-full relative transition-colors ${wafRules.ddos?'bg-emerald-500':'bg-slate-300'}`}><div className={`w-3 h-3 bg-white rounded-full absolute top-1 transition-all ${wafRules.ddos?'right-1':'left-1'}`}></div></button>
                  </div>
                </div>
             </div>

             {/* [æ–°å¢] å¼‚å¸¸è¡Œä¸ºç†”æ–­å™¨æ§åˆ¶é¢æ¿ */}
             <div className="bg-white p-6 rounded-xl border border-slate-100 shadow-sm border-l-4 border-l-orange-500">
                <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2 mb-6"><ZapOff className="text-orange-500"/> å¼‚å¸¸è¡Œä¸ºç†”æ–­å™¨ (Circuit Breaker)</h3>
                
                <div className="space-y-6">
                   <div className="p-4 bg-orange-50 rounded-xl border border-orange-100 flex flex-col gap-3">
                      <div className="flex items-center justify-between">
                         <span className="text-sm font-bold text-orange-900 flex items-center gap-2"><Power size={14}/> è‡ªåŠ¨ç«¯å£ç†”æ–­ (Port Fusion)</span>
                         <button onClick={()=>setCircuitBreakerConfig(p=>({...p, autoFusion: !p.autoFusion}))} className={`w-10 h-5 rounded-full relative transition-colors ${circuitBreakerConfig.autoFusion?'bg-orange-500':'bg-slate-300'}`}><div className={`w-3 h-3 bg-white rounded-full absolute top-1 transition-all ${circuitBreakerConfig.autoFusion?'right-1':'left-1'}`}></div></button>
                      </div>
                      <div className="flex items-center justify-between">
                         <span className="text-sm font-bold text-orange-900 flex items-center gap-2"><Hourglass size={14}/> å¼‚å¸¸è‡ªåŠ¨é™é€Ÿ (Auto Throttle)</span>
                         <button onClick={()=>setCircuitBreakerConfig(p=>({...p, autoThrottle: !p.autoThrottle}))} className={`w-10 h-5 rounded-full relative transition-colors ${circuitBreakerConfig.autoThrottle?'bg-orange-500':'bg-slate-300'}`}><div className={`w-3 h-3 bg-white rounded-full absolute top-1 transition-all ${circuitBreakerConfig.autoThrottle?'right-1':'left-1'}`}></div></button>
                      </div>
                   </div>

                   <div>
                      <div className="flex justify-between mb-2">
                         <span className="text-sm font-bold text-slate-600">è‡ªåŠ¨å†»ç»“æ—¶é•¿ (åˆ†é’Ÿ)</span>
                         <span className="text-sm font-mono text-orange-600">{circuitBreakerConfig.freezeDuration} min</span>
                      </div>
                      <input type="range" min="10" max="60" step="5" value={circuitBreakerConfig.freezeDuration} onChange={(e)=>setCircuitBreakerConfig(p=>({...p, freezeDuration: Number(e.target.value)}))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-orange-500"/>
                      <div className="flex justify-between text-xs text-slate-400 mt-1"><span>10m</span><span>35m</span><span>60m</span></div>
                   </div>

                   <div className="pt-2 border-t border-slate-100">
                      <button onClick={handleSimulateBreaker} className="w-full py-3 bg-slate-900 text-white border border-slate-800 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200/50">
                         <ZapOff size={18}/> æ¨¡æ‹Ÿå¼‚å¸¸æ”»å‡» (è§¦å‘ç†”æ–­)
                      </button>
                   </div>
                </div>
             </div>

             {/* Security Center - Identity & Weak Password Compensation */}
             <div className="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2 mb-4"><Fingerprint className="text-purple-500"/> èº«ä»½ä¸è®¿é—®æ§åˆ¶</h3>
                <div className="p-4 bg-purple-50 rounded-xl border border-purple-100 mb-4">
                   <h4 className="font-bold text-purple-900 text-sm mb-1 flex items-center gap-2"><LockKeyhole size={14}/> å¼±å¯†ç è¡¥å¿ç­–ç•¥ç”Ÿæ•ˆä¸­</h4>
                   <p className="text-xs text-purple-700 leading-relaxed">é’ˆå¯¹å­¦ç”Ÿè‡ªå®šä¹‰å¯†ç å¼ºåº¦ä¸è¶³çš„é£é™©ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨å¯ç”¨**è¡Œä¸ºé£æ§å¼•æ“**ã€‚ä»»ä½•éæƒ¯ç”¨è®¾å¤‡/IPç™»å½•å°†è§¦å‘äºŒæ¬¡éªŒè¯ã€‚</p>
                </div>
                <div className="flex items-center justify-between py-2 border-b border-slate-50">
                   <span className="text-sm text-slate-600">ç®¡ç†å‘˜ MFA å¼ºåˆ¶éªŒè¯</span>
                   <span className="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded">å·²å¼€å¯</span>
                </div>
                <div className="flex items-center justify-between py-2">
                   <span className="text-sm text-slate-600">å¼‚å¸¸åœ°ç†ä½ç½®ç™»å½•æ‹¦æˆª</span>
                   <span className="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded">å·²å¼€å¯</span>
                </div>
             </div>

             {/* Security Center - KMS & Data */}
             <div className="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2 mb-4"><Database className="text-blue-500"/> æ•°æ®å®‰å…¨ä¸å¯†é’¥ (KMS)</h3>
                
                <div className="space-y-3">
                   <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                      <div className="flex items-center gap-3">
                         <Key size={18} className="text-slate-400"/>
                         <div>
                            <div className="text-sm font-bold text-slate-700">ä¸»å¯†é’¥ (Master Key)</div>
                            <div className="text-xs text-slate-400">ä¸Šæ¬¡è½®æ¢: 3å¤©å‰</div>
                         </div>
                      </div>
                      <button className="text-xs bg-white border px-2 py-1 rounded hover:bg-slate-50">è½®æ¢</button>
                   </div>
                   
                   <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                      <div className="flex items-center gap-3">
                         <Database size={18} className="text-slate-400"/>
                         <div>
                            <div className="text-sm font-bold text-slate-700">æ•°æ®åº“å­—æ®µåŠ å¯†</div>
                            <div className="text-xs text-slate-400">AES-256 (æ‰‹æœºå·/èº«ä»½è¯)</div>
                         </div>
                      </div>
                      <span className="text-green-500"><CheckCircle size={16}/></span>
                   </div>
                </div>
             </div>
          </div>
        </div>
      );
      case 'encryption': return (
        <div className="max-w-4xl mx-auto space-y-8 py-4">
           {/* Header */}
           <div className="text-center space-y-2">
              <div className="inline-flex items-center justify-center w-16 h-16 bg-slate-900 rounded-full mb-4 shadow-xl border-4 border-indigo-500/30">
                 <ShieldCheck size={32} className="text-indigo-400"/>
              </div>
              <h2 className="text-2xl font-bold text-slate-800 tracking-tight">é›¶ä¿¡ä»»æ•°æ®ä¿é™©åº“</h2>
              <p className="text-slate-500 text-sm max-w-lg mx-auto">é‡‡ç”¨ AES-256-GCM ä¸åé‡å­å¯†ç å­¦ (Kyber-1024) æ··åˆåŠ å¯†æ¶æ„ã€‚å³ä½¿ç‰©ç†æœåŠ¡å™¨å¤±çªƒï¼Œæ•°æ®ä¾ç„¶ä¸å¯ç ´è§£ã€‚</p>
           </div>

           {/* Vault Status Card */}
           <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
              <div className="p-6 border-b border-slate-100 flex items-center justify-between">
                 <div className="flex items-center gap-4">
                    <div className={`w-3 h-3 rounded-full ${vaultStatus === 'locked' ? 'bg-red-500 animate-pulse' : 'bg-emerald-500'}`}></div>
                    <div>
                       <div className="font-bold text-slate-800">ä¿é™©åº“çŠ¶æ€: {vaultStatus === 'locked' ? 'å·²å°å­˜ (Sealed)' : 'æ´»è·ƒ (Active)'}</div>
                       <div className="text-xs text-slate-400 font-mono mt-1">UUID: 7f8c-9d2a-1e4b-5a0f</div>
                    </div>
                 </div>
                 <button onClick={() => setVaultStatus(vaultStatus === 'locked' ? 'unlocked' : 'locked')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2 ${vaultStatus === 'locked' ? 'bg-slate-900 text-white hover:bg-slate-800' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                    {vaultStatus === 'locked' ? <KeyRound size={16}/> : <Lock size={16}/>}
                    {vaultStatus === 'locked' ? 'è§£é”ä¿é™©åº“' : 'ç«‹å³å°å­˜'}
                 </button>
              </div>
              
              <div className="p-6 grid grid-cols-3 gap-6 bg-slate-50">
                 <div className="text-center p-4 bg-white rounded-xl border border-slate-100 shadow-sm">
                    <div className="text-xs text-slate-400 uppercase font-bold mb-2">åŠ å¯†ç®—æ³•</div>
                    <div className="text-indigo-600 font-bold font-mono">Kyber-1024</div>
                    <div className="text-[10px] text-slate-400 mt-1">Quantum Safe</div>
                 </div>
                 <div className="text-center p-4 bg-white rounded-xl border border-slate-100 shadow-sm">
                    <div className="text-xs text-slate-400 uppercase font-bold mb-2">å¯†é’¥åˆ†ç‰‡ (Shamir)</div>
                    <div className="text-emerald-600 font-bold font-mono">3 / 3 åœ¨çº¿</div>
                    <div className="text-[10px] text-slate-400 mt-1">Threshold Met</div>
                 </div>
                 <div className="text-center p-4 bg-white rounded-xl border border-slate-100 shadow-sm">
                    <div className="text-xs text-slate-400 uppercase font-bold mb-2">åŒæ€åŠ å¯†å¼•æ“</div>
                    <div className="text-orange-500 font-bold font-mono">Active</div>
                    <div className="text-[10px] text-slate-400 mt-1">Zero-Knowledge</div>
                 </div>
              </div>
           </div>

           {/* Interactive Encryption Demo */}
           <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                 <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><FileLock size={18}/> å®æ—¶æ•°æ®åŠ å¯†æ¼”ç¤º</h3>
                 <textarea 
                    className="w-full h-32 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4 transition-all"
                    placeholder="è¯·è¾“å…¥æ•æ„Ÿæ˜æ–‡æ•°æ® (å¦‚: å­¦ç”Ÿèº«ä»½è¯å·ã€å®¶åº­ä½å€)..."
                    value={encryptInput}
                    onChange={(e) => setEncryptInput(e.target.value)}
                 ></textarea>
                 <button onClick={handleSimulateEncryption} className="w-full py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2">
                    <RefreshCw size={16}/> æ‰§è¡Œé‡å­åŠ å¯†
                 </button>
              </div>
              <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-sm flex flex-col relative overflow-hidden">
                 <h3 className="font-bold text-slate-400 mb-4 flex items-center gap-2 text-sm uppercase tracking-wider"><Database size={16}/> å¯†æ–‡é¢„è§ˆ (Ciphertext)</h3>
                 <div className="flex-1 font-mono text-xs text-green-400 break-all overflow-y-auto max-h-[160px] leading-relaxed p-2 bg-black/20 rounded-lg">
                    {encryptedOutput || "// ç­‰å¾…è¾“å…¥æ•°æ®..."}
                 </div>
                 {encryptedOutput && (
                    <div className="absolute top-4 right-4">
                       <span className="flex h-3 w-3 relative">
                          <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span className="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                       </span>
                    </div>
                 )}
              </div>
           </div>

           {/* Panic Button */}
           <div className="bg-red-50 border border-red-100 rounded-2xl p-6 flex items-center justify-between">
              <div className="flex items-center gap-4">
                 <div className="p-3 bg-red-100 text-red-600 rounded-full">
                    <Skull size={24}/>
                 </div>
                 <div>
                    <h3 className="font-bold text-red-900">ç´§æ€¥ç†”æ–­ (Emergency Wipe)</h3>
                    <p className="text-xs text-red-700 mt-1 max-w-sm">ä¸€æ—¦è§¦å‘ï¼Œæ‰€æœ‰æœ¬åœ°å­˜å‚¨çš„ä¸»å¯†é’¥å°†è¢«ç‰©ç†æ“¦é™¤ã€‚æ•°æ®å°†æ°¸ä¹…æ— æ³•æ¢å¤ã€‚ä»…é™é¢ä¸´ç‰©ç†å…¥ä¾µæ—¶ä½¿ç”¨ã€‚</p>
                 </div>
              </div>
              <button className="px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 shadow-lg shadow-red-200 transition-all flex items-center gap-2" onClick={() => alert("æ¨¡æ‹Ÿï¼šå¯†é’¥å·²é”€æ¯ï¼Œå…¨ç«™æ•°æ®å·²é”å®šã€‚")}>
                 <Flame size={18}/> ç«‹å³é”€æ¯å¯†é’¥
              </button>
           </div>
        </div>
      );
      case 'nodes': return (
        <div className="bg-white p-6 rounded-xl border border-slate-100">
          <div className="flex justify-between mb-4"><h3 className="font-bold">èŠ‚ç‚¹ç®¡ç†</h3><div className="flex gap-2"><button onClick={()=>setShowNodeModal(true)} className="bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded text-sm flex items-center gap-1 hover:bg-slate-50"><Plus size={14}/> æ‰‹åŠ¨æ·»åŠ </button><button onClick={handleScanQRCode} className="bg-slate-900 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1"><QrCode size={14}/> æ‰«ç æ·»åŠ </button></div></div>
          <table className="w-full text-sm text-left"><thead><tr className="border-b text-slate-500"><th className="pb-2">åç§°</th><th className="pb-2">IP</th><th className="pb-2">å»¶è¿Ÿ</th><th className="pb-2">çŠ¶æ€</th></tr></thead><tbody>{nodes.map(n=>(<tr key={n.id} className="border-b last:border-0"><td className="py-3 font-medium">{n.name}</td><td className="py-3 text-slate-500 font-mono text-xs">{n.ip}</td><td className="py-3 text-green-600">{n.latency}</td><td className="py-3"><span className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs">{n.status}</span></td></tr>))}</tbody></table>
        </div>
      );
      case 'privacy': return (
        <div className="bg-white p-6 rounded-xl border border-slate-100">
          <div className="flex justify-between mb-6"><h3 className="font-bold flex items-center gap-2"><ShieldAlert className="text-rose-600"/> éšç§è§„åˆ™</h3></div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 className="font-bold text-sm mb-3 text-slate-600">é€šç”¨æ­£åˆ™è§„åˆ™åº“ (RegEx)</h4>
              <div className="space-y-3">{Object.keys(privacyRules).map(r=>(<div key={r} className="flex justify-between items-center p-3 border rounded-lg bg-slate-50"><span className="text-sm font-bold capitalize">{PRIVACY_LABELS[r] || r}</span><button onClick={()=>setPrivacyRules({...privacyRules,[r]:!privacyRules[r]})} className={`w-8 h-4 rounded-full relative transition-colors ${privacyRules[r]?'bg-indigo-600':'bg-slate-300'}`}><div className={`w-3 h-3 bg-white rounded-full absolute top-0.5 transition-all ${privacyRules[r]?'right-0.5':'left-0.5'}`}></div></button></div>))}</div>
            </div>
            <div>
               <h4 className="font-bold text-sm mb-3 text-slate-600">è‡ªå®šä¹‰æ•æ„Ÿè¯åº“ (åŠ¨æ€æ‹¦æˆª)</h4>
               <div className="bg-slate-50 border rounded-xl p-4 min-h-[200px]">
                 <div className="flex gap-2 mb-3">
                   <input className="flex-1 border rounded px-2 text-sm" placeholder="è¾“å…¥æ–°æ•æ„Ÿè¯..." value={newKeyword} onChange={e=>setNewKeyword(e.target.value)} onKeyDown={e=>{if(e.key==='Enter') addCustomKeyword()}}/>
                   <button onClick={addCustomKeyword} className="bg-indigo-600 text-white px-3 rounded text-sm"><Plus size={14}/></button>
                 </div>
                 <div className="flex flex-wrap gap-2">
                   {customKeywords.map(k => (
                     <span key={k} className="bg-white border border-slate-200 text-slate-600 px-2 py-1 rounded text-xs flex items-center gap-1">
                       {k} <button onClick={()=>removeCustomKeyword(k)} className="hover:text-red-500"><X size={10}/></button>
                     </span>
                   ))}
                 </div>
               </div>
            </div>
          </div>
          
          <h4 className="font-bold mt-6 mb-2 text-sm">è§„åˆ™æµ‹è¯•æ²™ç®±</h4>
          <textarea className="w-full border rounded-lg p-2 h-24 text-sm font-mono" placeholder="è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬ (å°è¯•è¾“å…¥æ‰‹æœºå·æˆ–è‡ªå®šä¹‰æ•æ„Ÿè¯)..." onChange={e=>{const res=localPrivacyFilter(e.target.value, privacyRules, customKeywords); document.getElementById('debug-out').innerHTML=res.sanitizedText.replace(/\[(.*?)\]/g, '<span class="text-red-500 font-bold">[$1]</span>')}}></textarea>
          <div className="mt-2 bg-slate-50 p-3 rounded text-xs text-slate-600 border border-slate-100 min-h-[40px]" id="debug-out">å®æ—¶é¢„è§ˆ...</div>
        </div>
      );
      case 'server': return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl border border-slate-100">
            <h3 className="font-bold mb-6 flex items-center gap-2"><Cpu className="text-indigo-500"/> æœåŠ¡å™¨çŠ¶æ€ç›‘æ§</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
               {/* Specs */}
               <div className="space-y-4">
                 <div className="p-4 bg-slate-50 rounded-lg border border-slate-100">
                   <div className="text-xs text-slate-500 uppercase mb-1 font-bold">CPU Processor</div>
                   <div className="font-mono text-sm text-slate-700">{serverConfig.cpu}</div>
                 </div>
                 <div className="p-4 bg-slate-50 rounded-lg border border-slate-100">
                   <div className="text-xs text-slate-500 uppercase mb-1 font-bold">Memory (RAM)</div>
                   <div className="font-mono text-sm text-slate-700">{serverConfig.ram}</div>
                 </div>
                 <div className="p-4 bg-slate-50 rounded-lg border border-slate-100">
                   <div className="text-xs text-slate-500 uppercase mb-1 font-bold">GPU Accelerator</div>
                   <div className="font-mono text-sm text-slate-700">{serverConfig.gpu}</div>
                 </div>
               </div>
               {/* Live Charts */}
               <div className="space-y-6">
                  {/* CPU Bar */}
                  <div>
                    <div className="flex justify-between text-sm mb-2 font-medium"><span>CPU Load</span><span className={serverStats.cpu>80?'text-red-500':''}>{serverStats.cpu}%</span></div>
                    <div className="h-3 bg-slate-100 rounded-full overflow-hidden"><div style={{width: serverStats.cpu+'%'}} className={`h-full transition-all duration-500 ${serverStats.cpu>80?'bg-red-500':'bg-indigo-500'}`}></div></div>
                  </div>
                  {/* RAM Bar */}
                  <div>
                    <div className="flex justify-between text-sm mb-2 font-medium"><span>RAM Usage</span><span className={serverStats.ram>80?'text-red-500':''}>{serverStats.ram}%</span></div>
                    <div className="h-3 bg-slate-100 rounded-full overflow-hidden"><div style={{width: serverStats.ram+'%'}} className={`h-full transition-all duration-500 ${serverStats.ram>80?'bg-red-500':'bg-emerald-500'}`}></div></div>
                  </div>
                   {/* GPU Bar */}
                   <div>
                    <div className="flex justify-between text-sm mb-2 font-medium"><span>GPU Load</span><span className={serverStats.gpu>80?'text-red-500':''}>{serverStats.gpu}%</span></div>
                    <div className="h-3 bg-slate-100 rounded-full overflow-hidden"><div style={{width: serverStats.gpu+'%'}} className={`h-full transition-all duration-500 ${serverStats.gpu>80?'bg-red-500':'bg-purple-500'}`}></div></div>
                  </div>
                   {/* Temp Bar */}
                   <div>
                    <div className="flex justify-between text-sm mb-2 font-medium"><span>Temperature</span><span className={serverStats.temp>80?'text-red-500':''}>{serverStats.temp}Â°C</span></div>
                    <div className="h-3 bg-slate-100 rounded-full overflow-hidden"><div style={{width: (serverStats.temp/100)*100+'%'}} className={`h-full transition-all duration-500 ${serverStats.temp>80?'bg-red-500':'bg-orange-400'}`}></div></div>
                  </div>
                  
                  <div className="pt-2">
                     <button onClick={handleAiServerAnalysis} disabled={isAnalyzingServer} className="w-full py-3 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-colors flex items-center justify-center gap-2">
                       {isAnalyzingServer ? <RefreshCw className="animate-spin" size={16}/> : <BrainCircuit size={16}/>} 
                       {isAnalyzingServer ? "AI æ­£åœ¨è¯Šæ–­ç¡¬ä»¶å¥åº·..." : "å¯åŠ¨ AI ç¡¬ä»¶æ·±åº¦è¯Šæ–­"}
                     </button>
                     {aiServerAnalysis && (
                       <div className="mt-4 p-4 bg-indigo-50 border border-indigo-100 rounded-xl text-indigo-900 text-sm flex items-start gap-3 animate-in slide-in-from-top-2">
                         <Sparkles className="flex-shrink-0 mt-0.5 text-indigo-600" size={16}/>
                         <div>{aiServerAnalysis}</div>
                       </div>
                     )}
                  </div>
               </div>
            </div>
          </div>
        </div>
      );
      case 'api': return (
        <div className="bg-white p-6 rounded-xl border border-slate-100">
          <div className="flex justify-between mb-4"><h3 className="font-bold flex items-center gap-2"><Zap className="text-amber-500"/> API æ± </h3><button onClick={()=>setShowApiModal(true)} className="bg-slate-900 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1"><Plus size={14}/> æ·»åŠ </button></div>
          <div className="space-y-3">{apiKeys.map(k=>(<div key={k.id} className="flex justify-between items-center p-3 border rounded-lg"><div className="flex items-center gap-2 font-bold text-slate-700">{k.provider} <span className="text-xs font-normal bg-slate-100 px-2 rounded border">{k.model}</span></div><div className="flex items-center gap-2"><span className="text-xs bg-slate-100 px-2 py-1 rounded">{k.alias}</span><button onClick={()=>handleDeleteApiKey(k.id)} className="text-slate-400 hover:text-red-500"><Trash2 size={16}/></button></div></div>))}</div>
        </div>
      );
      case 'logs': return (
        <div className="bg-white p-6 rounded-xl border border-slate-100">
           <div className="flex justify-between items-center mb-6">
            <h3 className="font-bold flex items-center gap-2"><FileText className="text-slate-500"/> ç³»ç»Ÿå®¡è®¡æ—¥å¿—</h3>
            <button onClick={handleAiLogAnalysis} disabled={isAnalyzingLogs} className="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-100 flex items-center gap-2 transition-colors">
              {isAnalyzingLogs ? <RefreshCw className="animate-spin" size={14}/> : <ShieldCheck size={14}/>} 
              AI å¼‚å¸¸æ£€æµ‹
            </button>
          </div>
          {aiAnalysis && <div className="mb-6 p-4 bg-green-50 text-green-800 rounded-xl border border-green-100 text-sm flex items-center gap-2 animate-in fade-in"><CheckCircle size={16}/> {aiAnalysis}</div>}
          <div className="overflow-hidden rounded-lg border border-slate-200">
            <table className="w-full text-sm text-left">
              <thead className="bg-slate-50 text-slate-500">
                <tr><th className="px-4 py-3">æ—¶é—´</th><th className="px-4 py-3">ç”¨æˆ·</th><th className="px-4 py-3">æ“ä½œ</th><th className="px-4 py-3">è¯¦æƒ…</th><th className="px-4 py-3">çŠ¶æ€</th></tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {logs.map(log=>(
                  <tr key={log.id} className="hover:bg-slate-50">
                    <td className="px-4 py-3 font-mono text-xs text-slate-500">{log.time}</td>
                    <td className="px-4 py-3 font-medium">{log.user}</td>
                    <td className="px-4 py-3">{log.action}</td>
                    <td className="px-4 py-3 text-slate-500 max-w-xs truncate" title={log.detail}>{log.detail}</td>
                    <td className="px-4 py-3"><span className={`px-2 py-1 rounded text-xs font-medium ${log.status==='warning'?'bg-orange-100 text-orange-700':log.status==='error'?'bg-red-100 text-red-700':'bg-green-100 text-green-700'}`}>{log.status}</span></td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
      case 'knowledge': return (
        <div className="bg-white p-6 rounded-xl border border-slate-100">
          <div className="flex justify-between items-center mb-6">
             <div>
               <h3 className="font-bold flex items-center gap-2"><BookOpen className="text-indigo-500"/> RAG çŸ¥è¯†åº“ç®¡ç†</h3>
               <p className="text-xs text-slate-400 mt-1">ä¸Šä¼ æ–‡æ¡£ä»¥å¢å¼º AI å¯¼å¸ˆçš„å›ç­”å‡†ç¡®æ€§</p>
             </div>
             <button className="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-slate-800"><UploadCloud size={16}/> ä¸Šä¼ æ–°æ–‡æ¡£</button>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {knowledgeFiles.map(f => (
              <div key={f.id} className="p-4 border border-slate-200 rounded-xl flex items-start gap-4 hover:border-indigo-200 hover:shadow-sm transition-all bg-white group">
                <div className={`w-12 h-12 rounded-lg flex items-center justify-center flex-shrink-0 ${f.type==='PDF'?'bg-red-50 text-red-500':'bg-blue-50 text-blue-500'}`}>
                   <FileText size={24}/>
                </div>
                <div className="flex-1 min-w-0">
                   <div className="font-bold text-slate-800 text-sm mb-1 truncate">{f.name}</div>
                   <div className="text-xs text-slate-400 mb-3 flex items-center gap-2">
                      <span>{f.size}</span>
                      <span>â€¢</span>
                      <span>{f.date}</span>
                   </div>
                   <div className="flex gap-2">
                     <button onClick={() => handleAiFileAnalysis(f)} disabled={aiFileAnalysis?.loading && aiFileAnalysis?.id === f.id} className="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded text-xs font-bold hover:bg-indigo-100 transition-colors flex items-center gap-1">
                        {aiFileAnalysis?.loading && aiFileAnalysis?.id === f.id ? <RefreshCw className="animate-spin" size={12}/> : <Sparkles size={12}/>} 
                        AI æ‘˜è¦
                     </button>
                     <button className="px-3 py-1.5 bg-slate-50 text-slate-500 rounded text-xs hover:bg-red-50 hover:text-red-600 transition-colors flex items-center gap-1"><Trash2 size={12}/> åˆ é™¤</button>
                   </div>
                   {aiFileAnalysis?.id === f.id && !aiFileAnalysis.loading && (
                     <div className="mt-3 p-3 bg-slate-50 rounded-lg text-xs text-slate-600 leading-relaxed border border-slate-100 animate-in slide-in-from-top-1">
                        {aiFileAnalysis.content}
                     </div>
                   )}
                </div>
              </div>
            ))}
            {/* Upload Placeholder */}
            <div className="border-2 border-dashed border-slate-200 rounded-xl flex flex-col items-center justify-center p-6 text-slate-400 hover:border-indigo-400 hover:text-indigo-500 transition-colors cursor-pointer min-h-[140px]">
               <UploadCloud size={32} className="mb-2 opacity-50"/>
               <span className="text-sm font-medium">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶ä¸Šä¼ </span>
               <span className="text-xs opacity-60 mt-1">æ”¯æŒ PDF, Word, TXT (Max 10MB)</span>
            </div>
          </div>
        </div>
      );
      default: return null;
    }
  };

  return (
    <div className="flex h-screen bg-slate-50 font-sans text-slate-800 overflow-hidden">
      {showScanner && <ScannerM/>} {showUserModal && <AddUserM/>} {showExtendModal && <ExtendM/>} {showNodeModal && <AddNodeM/>} {showApiModal && <AddApiM/>}
      {showUserLogsModal && <UserLogsM/>}
      {showEditUserModal && <EditUserM/>}
      <aside className={`bg-slate-900 text-white flex flex-col transition-all duration-300 ${isSidebarOpen ? 'w-64' : 'w-20'}`}>
        <div className="p-6 flex items-center gap-3 border-b border-slate-800"><div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center flex-shrink-0"><Shield size={18} className="text-white"/></div>{isSidebarOpen && <div><h1 className="font-bold text-sm tracking-wide">{API_CONFIG.COMPANY_NAME}</h1><p className="text-[10px] text-slate-400">äº‘ç«¯æ§åˆ¶å° Pro</p></div>}</div>
        <nav className="flex-1 p-4 space-y-2 overflow-y-auto">{[{id:'dashboard',icon:LayoutDashboard,l:'æ¦‚è§ˆ'},{id:'security',icon:ShieldCheck,l:'å®‰å…¨é£æ§ä¸­å°'},{id:'encryption',icon:LockKeyhole,l:'æ•°æ®ä¿é™©åº“'},{id:'server',icon:Cpu,l:'æœåŠ¡å™¨'},{id:'api',icon:Zap,l:'APIæ± '},{id:'nodes',icon:Server,l:'èŠ‚ç‚¹'},{id:'users',icon:Users,l:'ç”¨æˆ·'},{id:'knowledge',icon:BookOpen,l:'çŸ¥è¯†åº“'},{id:'privacy',icon:ShieldAlert,l:'éšç§è§„åˆ™'},{id:'logs',icon:FileText,l:'æ—¥å¿—'}].map(i=>(<button key={i.id} onClick={()=>setCurrentView(i.id)} className={`w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-all ${currentView===i.id?'bg-indigo-600 text-white shadow-lg':'text-slate-400 hover:bg-slate-800 hover:text-white'}`}><i.icon size={20}/>{isSidebarOpen && <span className="text-sm font-medium">{i.l}</span>}</button>))}</nav>
        <div className="p-4 border-t border-slate-800 bg-slate-900 z-10"><button onClick={()=>setShowStudentPreview(true)} className="w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-indigo-400 px-4 py-2 rounded-lg text-sm mb-4"><Smartphone size={16}/>{isSidebarOpen && "é¢„è§ˆå­¦ç”Ÿç«¯"}</button></div>
      </aside>
      <main className="flex-1 flex flex-col min-w-0 bg-slate-50">
        <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 sticky top-0 z-20 shadow-sm"><div className="flex items-center gap-4"><button onClick={()=>setSidebarOpen(!isSidebarOpen)} className="text-slate-500 hover:bg-slate-100 p-2 rounded-lg"><Menu size={20}/></button><h2 className="text-lg font-bold text-slate-800">{currentView === 'security' ? 'å®‰å…¨é£æ§ä¸­å°' : currentView === 'privacy' ? 'éšç§è§„åˆ™é…ç½®' : currentView === 'encryption' ? 'æ•°æ®ä¿é™©åº“' : currentView.toUpperCase()}</h2></div></header>
        <div className="flex-1 overflow-auto p-6 scroll-smooth">{renderContent()}</div>
      </main>
    </div>
  );
}
